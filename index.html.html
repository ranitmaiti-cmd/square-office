<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SQUARE - Office Management</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f4f8;color:#2d3748;}

/* LOGIN */
.login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#1a365d,#2b6cb0);}
.login-card{background:white;padding:40px;border-radius:16px;width:380px;box-shadow:0 20px 60px rgba(0,0,0,0.3);}
.login-logo{text-align:center;margin-bottom:30px;}
.login-logo h1{font-size:32px;font-weight:800;color:#2b6cb0;letter-spacing:4px;}
.login-logo p{color:#718096;font-size:14px;margin-top:4px;}
.login-error{background:#fed7d7;color:#9b2c2c;padding:10px;border-radius:6px;margin-bottom:16px;font-size:13px;}

/* LAYOUT */
.app{display:flex;flex-direction:column;min-height:100vh;}
.topbar{background:white;padding:14px 24px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.08);position:sticky;top:0;z-index:100;}
.app-logo{font-size:20px;font-weight:800;color:#2b6cb0;letter-spacing:3px;}
.user-badge{background:#ebf4ff;color:#2b6cb0;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:600;}
.admin-badge{background:#faf5ff;color:#6b46c1;padding:3px 8px;border-radius:10px;font-size:11px;font-weight:600;margin-left:6px;}
.main{display:flex;flex:1;}
.sidebar{width:220px;background:white;padding:16px 0;box-shadow:2px 0 8px rgba(0,0,0,0.05);flex-shrink:0;}
.nav-section{padding:6px 20px 4px;font-size:10px;font-weight:700;text-transform:uppercase;color:#a0aec0;letter-spacing:1px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 20px;cursor:pointer;font-size:13px;font-weight:500;color:#4a5568;transition:all 0.2s;border-left:3px solid transparent;}
.nav-item:hover{background:#f7fafc;color:#2b6cb0;}
.nav-item.active{background:#ebf4ff;color:#2b6cb0;border-left-color:#2b6cb0;font-weight:600;}
.nav-icon{font-size:15px;width:20px;text-align:center;}
.nav-badge{margin-left:auto;background:#e53e3e;color:white;border-radius:10px;padding:1px 7px;font-size:11px;font-weight:700;}
.content{flex:1;padding:24px;overflow-y:auto;max-height:calc(100vh - 60px);}
.page{display:none;}.page.active{display:block;}

/* FORMS */
.form-group{margin-bottom:14px;}
.form-label{display:block;margin-bottom:5px;font-weight:500;font-size:13px;color:#4a5568;}
.form-control{width:100%;padding:9px 12px;border:2px solid #e2e8f0;border-radius:8px;font-size:13px;transition:border 0.2s;background:white;}
.form-control:focus{outline:none;border-color:#2b6cb0;}
textarea.form-control{min-height:70px;resize:vertical;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}

/* BUTTONS */
.btn{padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;}
.btn-primary{background:#2b6cb0;color:white;}.btn-primary:hover{background:#2c5282;}
.btn-success{background:#38a169;color:white;}.btn-success:hover{background:#276749;}
.btn-danger{background:#e53e3e;color:white;}.btn-danger:hover{background:#9b2c2c;}
.btn-warning{background:#d69e2e;color:white;}.btn-warning:hover{background:#b7791f;}
.btn-ghost{background:#edf2f7;color:#4a5568;}.btn-ghost:hover{background:#e2e8f0;}
.btn-sm{padding:5px 11px;font-size:12px;}
.btn-block{width:100%;padding:12px;font-size:14px;}

/* CARDS */
.card{background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:16px;}
.card-title{font-size:15px;font-weight:700;color:#1a202c;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.page-title{font-size:20px;font-weight:700;margin-bottom:20px;}

/* BADGES */
.badge{display:inline-block;padding:2px 9px;border-radius:10px;font-size:11px;font-weight:700;text-transform:uppercase;}
.badge-pending{background:#feebc8;color:#c05621;}.badge-approved{background:#c6f6d5;color:#276749;}.badge-rejected{background:#fed7d7;color:#9b2c2c;}
.badge-planned{background:#ebf4ff;color:#2b6cb0;}.badge-emergency{background:#fff5f5;color:#e53e3e;}
.badge-done{background:#f0fff4;color:#276749;}

/* MODAL */
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;align-items:center;justify-content:center;}
.modal-backdrop.open{display:flex;}
.modal-box{background:white;border-radius:16px;padding:24px;width:90%;max-width:580px;max-height:90vh;overflow-y:auto;}
.modal-box.wide{max-width:720px;}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
.modal-head h3{font-size:17px;font-weight:700;}
.close-btn{background:none;border:none;font-size:22px;cursor:pointer;color:#718096;line-height:1;padding:0 4px;}

/* CALENDAR / DASHBOARD */
.week-nav{display:flex;justify-content:space-between;align-items:center;background:white;padding:12px 18px;border-radius:10px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.week-label{font-weight:700;font-size:14px;}
.cal-wrap{background:white;border-radius:12px;overflow-x:auto;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.cal-grid{min-width:960px;}
.cal-head{display:grid;grid-template-columns:150px repeat(7,1fr);gap:4px;margin-bottom:5px;}
.cal-head-cell{text-align:center;font-size:11px;font-weight:700;color:#4a5568;padding:7px 4px;background:#f7fafc;border-radius:6px;}
.cal-row{display:grid;grid-template-columns:150px repeat(7,1fr);gap:4px;margin-bottom:4px;}
.cal-name{display:flex;align-items:center;font-size:12px;font-weight:600;padding:0 6px;}
.cal-cell{background:#f7fafc;border-radius:6px;padding:4px;min-height:52px;border:1px solid #e2e8f0;position:relative;}
.cal-cell.today{border-color:#2b6cb0;background:#ebf4ff;}
.cal-cell.holiday{background:#fafafa;opacity:0.7;}
.chip{font-size:10px;padding:2px 5px;border-radius:3px;margin-bottom:2px;cursor:pointer;border-left:3px solid;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;}
.chip-task{background:#f0fff4;border-color:#38a169;}
.chip-task.emergency{background:#fff5f5;border-color:#e53e3e;}
.chip-task.planned{background:#ebf4ff;border-color:#2b6cb0;}
.chip-leave{background:#fed7d7;color:#9b2c2c;border-color:#e53e3e;}
.chip-log{background:#faf5ff;border-color:#6b46c1;}

/* PROJECT BUDGET */
.project-card{background:white;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin-bottom:12px;border-left:5px solid #2b6cb0;}
.project-card.over{border-left-color:#e53e3e;}
.project-card.near{border-left-color:#d69e2e;}
.project-card.ok{border-left-color:#38a169;}
.phase-row{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid #f0f4f8;font-size:13px;}
.phase-row:last-child{border-bottom:none;}
.phase-name{width:220px;flex-shrink:0;font-weight:500;}
.phase-bar-wrap{flex:1;background:#e2e8f0;border-radius:4px;height:8px;}
.phase-bar-fill{height:8px;border-radius:4px;transition:width 0.4s;}
.phase-bar-fill.ok{background:#38a169;}.phase-bar-fill.near{background:#d69e2e;}.phase-bar-fill.over{background:#e53e3e;}
.phase-nums{width:160px;text-align:right;font-size:12px;color:#718096;flex-shrink:0;}
.phase-nums strong{color:#1a202c;}

/* PLANNER */
.planner-grid{min-width:1100px;}
.planner-head{display:grid;grid-template-columns:150px repeat(7,1fr);gap:4px;margin-bottom:5px;}
.planner-head-cell{text-align:center;font-size:11px;font-weight:700;padding:8px 4px;background:#f7fafc;border-radius:6px;color:#4a5568;}
.planner-row{display:grid;grid-template-columns:150px repeat(7,1fr);gap:4px;margin-bottom:4px;}
.planner-name{display:flex;align-items:center;font-size:12px;font-weight:600;padding:0 6px;}
.planner-cell{background:#f7fafc;border-radius:6px;padding:5px;min-height:60px;border:2px dashed #e2e8f0;cursor:pointer;transition:border-color 0.2s;}
.planner-cell:hover{border-color:#90cdf4;background:#f0f9ff;}
.planner-cell.has-items{border-style:solid;border-color:#e2e8f0;}
.plan-chip{font-size:10px;padding:2px 5px;border-radius:3px;margin-bottom:2px;display:block;cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.plan-chip.planned{background:#ebf4ff;border-left:3px solid #2b6cb0;}
.plan-chip.emergency{background:#fff5f5;border-left:3px solid #e53e3e;}
.plan-chip.done{background:#f0fff4;border-left:3px solid #38a169;text-decoration:line-through;opacity:0.7;}

/* TIME LOG */
.log-card{background:white;border:1px solid #e2e8f0;border-radius:10px;padding:12px 14px;margin-bottom:8px;display:flex;gap:12px;align-items:flex-start;}
.log-card:hover{border-color:#bee3f8;}
.log-time{display:inline-flex;align-items:center;gap:4px;background:#ebf4ff;color:#2b6cb0;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:800;white-space:nowrap;}
.log-body{flex:1;}
.log-meta{font-size:11px;color:#718096;margin:3px 0;}
.log-desc{font-size:13px;color:#4a5568;}
.log-right{text-align:right;flex-shrink:0;}
.log-date{font-size:11px;color:#a0aec0;}
.linked-tag{background:#f0fff4;color:#276749;border:1px solid #9ae6b4;padding:1px 6px;border-radius:5px;font-size:10px;font-weight:600;}
.indep-tag{background:#faf5ff;color:#6b46c1;border:1px solid #d6bcfa;padding:1px 6px;border-radius:5px;font-size:10px;font-weight:600;}
.prod-tag{background:#ebfff4;color:#276749;padding:1px 6px;border-radius:5px;font-size:10px;font-weight:600;border:1px solid #9ae6b4;}
.nonprod-tag{background:#fff5f5;color:#e53e3e;padding:1px 6px;border-radius:5px;font-size:10px;font-weight:600;border:1px solid #feb2b2;}
.total-bar{background:#ebf4ff;color:#2b6cb0;padding:10px 16px;border-radius:10px;font-size:17px;font-weight:800;margin-bottom:14px;}
.total-bar span{font-size:12px;font-weight:400;color:#718096;display:block;margin-top:2px;}
.filter-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:14px;}
.filter-row .form-control{width:auto;min-width:130px;}

/* REPORTS */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px;}
.stat-card{background:white;border-radius:12px;padding:16px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.06);border-top:4px solid #2b6cb0;}
.stat-card.g{border-top-color:#38a169;}.stat-card.o{border-top-color:#d69e2e;}.stat-card.p{border-top-color:#6b46c1;}.stat-card.r{border-top-color:#e53e3e;}
.stat-num{font-size:26px;font-weight:800;}.stat-lbl{font-size:11px;color:#718096;margin-top:2px;}
.rpt-table{width:100%;border-collapse:collapse;font-size:12px;}
.rpt-table th{background:#f7fafc;padding:9px 12px;text-align:left;font-weight:700;color:#4a5568;border-bottom:2px solid #e2e8f0;}
.rpt-table td{padding:9px 12px;border-bottom:1px solid #f0f4f8;vertical-align:middle;}
.rpt-table .sub td{padding:3px 12px 3px 26px;border:none;font-size:11px;color:#4a5568;background:transparent;}
.bar-wrap{background:#e2e8f0;border-radius:4px;height:6px;min-width:50px;}
.bar-fill{height:6px;border-radius:4px;background:#2b6cb0;}

/* TIMER WIDGET */
.timer-widget{position:fixed;bottom:24px;right:24px;background:white;border-radius:14px;padding:0;box-shadow:0 8px 30px rgba(0,0,0,0.18);z-index:400;display:flex;flex-direction:column;width:240px;border:2px solid #e2e8f0;user-select:none;}
.timer-widget.running{border-color:#38a169;box-shadow:0 8px 30px rgba(56,161,105,0.2);}
.timer-handle{background:#f7fafc;border-radius:12px 12px 0 0;padding:7px 12px;cursor:grab;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e2e8f0;font-size:11px;font-weight:600;color:#718096;}
.timer-handle:active{cursor:grabbing;}
.timer-body{padding:12px 14px;display:flex;flex-direction:column;gap:8px;}
.timer-display{font-size:30px;font-weight:800;font-variant-numeric:tabular-nums;text-align:center;color:#1a202c;letter-spacing:2px;line-height:1;}
.timer-display.running{color:#38a169;}
.timer-status{font-size:11px;color:#718096;text-align:center;}
.timer-project{font-size:11px;font-weight:600;color:#2b6cb0;text-align:center;background:#ebf4ff;padding:3px 8px;border-radius:5px;}
.timer-btns{display:flex;gap:5px;flex-wrap:wrap;}
.timer-btns .btn{flex:1;font-size:11px;padding:6px 8px;}

/* MANAGE */
.manage-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.add-row{display:flex;gap:8px;margin-bottom:10px;}
.add-row .form-control{flex:1;}
.list-item{display:flex;justify-content:space-between;align-items:center;padding:9px 4px;border-bottom:1px solid #f0f4f8;}
.list-item:last-child{border-bottom:none;}

/* LEAVE */
.balance-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px;}
.balance-card{background:white;border-radius:12px;padding:18px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.balance-num{font-size:34px;font-weight:800;margin-bottom:3px;}
.balance-sub{font-size:12px;color:#718096;}
.bal-bar{background:#e2e8f0;border-radius:4px;height:5px;margin-top:8px;}
.bal-fill{height:5px;border-radius:4px;}

/* APPROVAL */
.approval-card{background:white;border:1px solid #e2e8f0;border-radius:10px;padding:14px;margin-bottom:10px;border-left:4px solid #d69e2e;}
.change-box{background:#fffaf0;border:2px solid #d69e2e;border-radius:8px;padding:14px;margin-top:14px;}
.change-box h4{color:#c05621;font-weight:700;margin-bottom:10px;}

/* RADIO / INFO */
.radio-group{display:flex;gap:14px;flex-wrap:wrap;}
.radio-group label{display:flex;align-items:center;gap:5px;cursor:pointer;font-size:13px;}
.info-box{background:#f7fafc;border-radius:8px;padding:10px 12px;font-size:12px;color:#4a5568;margin-bottom:12px;}

/* NOTIFICATION TOAST */
.notification-toast{position:fixed;top:80px;right:-400px;background:white;border-radius:12px;padding:16px 20px;box-shadow:0 8px 30px rgba(0,0,0,0.15);z-index:600;max-width:350px;transition:right 0.3s;border-left:4px solid #2b6cb0;}
.notification-toast.show{right:24px;}
.notification-toast.warning{border-left-color:#d69e2e;background:#fffaf0;}
.notification-toast.error{border-left-color:#e53e3e;background:#fff5f5;}
.notif-title{font-weight:700;font-size:14px;margin-bottom:4px;}
.notif-msg{font-size:13px;color:#4a5568;}

@media(max-width:700px){.sidebar{display:none;}.form-row,.form-row-3,.manage-grid,.balance-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="login-logo"><h1>SQUARE</h1><p>Office Management System</p></div>
    <div class="login-error" id="loginError" style="display:none;"></div>
    <div class="form-group">
      <label class="form-label">Email</label>
      <input type="email" class="form-control" id="loginEmail" placeholder="your@square.com">
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input type="password" class="form-control" id="loginPassword" placeholder="Password">
    </div>
    <button class="btn btn-primary btn-block" id="loginBtn">Login</button>
    <p style="text-align:center;margin-top:12px;font-size:12px;color:#a0aec0;">admin@square.com / admin123</p>
  </div>
</div>

<!-- MAIN APP -->
<div class="app" id="mainApp" style="display:none;">
  <div class="topbar">
    <span class="app-logo">SQUARE</span>
    <div style="display:flex;align-items:center;gap:10px;">
      <span class="user-badge"><span id="topbarName"></span><span class="admin-badge" id="adminBadge" style="display:none;">ADMIN</span></span>
      <button class="btn btn-ghost btn-sm" id="logoutBtn">Logout</button>
    </div>
  </div>
  <div class="main">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="nav-section">Planning</div>
      <div class="nav-item active" data-page="dashboard"><span class="nav-icon">üìä</span>Dashboard</div>
      <div class="nav-item" data-page="planner"><span class="nav-icon">üìÖ</span>Weekly Planner</div>
      <div class="nav-section">Work</div>
      <div class="nav-item" data-page="timelog"><span class="nav-icon">‚è±Ô∏è</span>Time Log</div>
      <div class="nav-item" data-page="projects"><span class="nav-icon">üìÅ</span>Projects & Budget</div>
      <div class="nav-section">Admin</div>
      <div class="nav-item" data-page="timereport"><span class="nav-icon">üìà</span>Time Report</div>
      <div class="nav-item" data-page="leaves"><span class="nav-icon">üå¥</span>Leave</div>
      <div class="nav-item" data-page="approvals"><span class="nav-icon">‚úÖ</span>Approvals<span class="nav-badge" id="approvalBadge" style="display:none;">0</span></div>
      <div class="nav-item admin-only" data-page="manage" style="display:none;"><span class="nav-icon">‚öôÔ∏è</span>Manage</div>
      <div style="border-top:1px solid #e2e8f0;margin:10px 0;"></div>
      <div class="nav-item" id="timerNavBtn" style="color:#38a169;font-weight:600;"><span class="nav-icon">‚ñ∂</span><span id="timerNavLabel">Start Timer</span></div>
    </div>

    <!-- CONTENT -->
    <div class="content">

      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <h2 class="page-title">üìä Dashboard</h2>
        
        <!-- Analytics Cards -->
        <div class="stats-grid" id="dashAnalytics" style="margin-bottom:20px;"></div>
        
        <!-- Quick Actions -->
        <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
          <button class="btn btn-primary btn-sm" id="dashAddHoliday">üìÖ Add Holiday</button>
          <button class="btn btn-ghost btn-sm" id="dashViewHolidays">View Holidays</button>
        </div>
        
        <!-- Weekly Calendar -->
        <div class="week-nav">
          <button class="btn btn-ghost btn-sm" id="prevWeek">‚Üê Prev</button>
          <span class="week-label" id="weekLabel"></span>
          <button class="btn btn-ghost btn-sm" id="nextWeek">Next ‚Üí</button>
        </div>
        <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;">
          <span style="font-size:12px;display:flex;align-items:center;gap:4px;"><span style="width:10px;height:10px;background:#ebf4ff;border-left:3px solid #2b6cb0;display:inline-block;"></span> Planned</span>
          <span style="font-size:12px;display:flex;align-items:center;gap:4px;"><span style="width:10px;height:10px;background:#fff5f5;border-left:3px solid #e53e3e;display:inline-block;"></span> Emergency</span>
          <span style="font-size:12px;display:flex;align-items:center;gap:4px;"><span style="width:10px;height:10px;background:#faf5ff;border-left:3px solid #6b46c1;display:inline-block;"></span> Time Logged</span>
          <span style="font-size:12px;display:flex;align-items:center;gap:4px;"><span style="width:10px;height:10px;background:#fed7d7;border-left:3px solid #e53e3e;display:inline-block;"></span> Leave</span>
          <span style="font-size:12px;display:flex;align-items:center;gap:4px;"><span style="width:10px;height:10px;background:#fef3c7;border-left:3px solid #f59e0b;display:inline-block;"></span> Holiday</span>
        </div>
        <div class="cal-wrap"><div class="cal-grid" id="calGrid"></div></div>
      </div>

      <!-- WEEKLY PLANNER -->
      <div class="page" id="page-planner">
        <div class="section-header">
          <h2 class="page-title" style="margin:0;">üìÖ Weekly Planner</h2>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn btn-ghost btn-sm" id="planPrev">‚Üê Prev</button>
            <span id="planWeekLabel" style="font-weight:700;font-size:14px;"></span>
            <button class="btn btn-ghost btn-sm" id="planNext">Next ‚Üí</button>
          </div>
        </div>
        <div style="background:#fffaf0;border:1px solid #fbd38d;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:13px;color:#c05621;">
          üìå Planning is mandatory. Click any cell to assign work for that person on that day.
        </div>
        <div class="cal-wrap"><div class="planner-grid" id="plannerGrid"></div></div>
      </div>

      <!-- TIME LOG -->
      <div class="page" id="page-timelog">
        <div class="section-header">
          <h2 class="page-title" style="margin:0;">‚è±Ô∏è Time Log</h2>
          <button class="btn btn-primary" id="addLogBtn">+ Log Non-Productive Time</button>
        </div>
        <div class="filter-row">
          <select class="form-control" id="tlMonth">
            <option value="-1">All Months</option>
            <option value="0">January</option><option value="1">February</option><option value="2">March</option>
            <option value="3">April</option><option value="4">May</option><option value="5">June</option>
            <option value="6">July</option><option value="7">August</option><option value="8">September</option>
            <option value="9">October</option><option value="10">November</option><option value="11">December</option>
          </select>
          <select class="form-control" id="tlProject"><option value="">All Projects</option></select>
          <select class="form-control" id="tlType"><option value="">All Types</option><option value="productive">Productive</option><option value="non-productive">Non-Productive</option></select>
          <button class="btn btn-ghost btn-sm" id="tlFilterBtn">Filter</button>
        </div>
        <div class="total-bar" id="tlTotal">0h 00m<span>no entries</span></div>
        <div id="timeLogList"></div>
      </div>

      <!-- PROJECTS & BUDGET -->
      <div class="page" id="page-projects">
        <div class="section-header">
          <h2 class="page-title" style="margin:0;">üìÅ Projects & Budget</h2>
          <button class="btn btn-primary admin-only" id="addProjectBtn" style="display:none;">+ New Project</button>
        </div>
        <div id="projectsBudgetList"></div>
      </div>

      <!-- TIME REPORT -->
      <div class="page" id="page-timereport">
        <div class="section-header"><h2 class="page-title" style="margin:0;">üìà Time Report</h2></div>
        <div class="card" style="margin-bottom:18px;">
          <div class="card-title">üîç Filter</div>
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group" style="margin:0;"><label class="form-label">From Month</label>
              <select class="form-control" id="trFrom"><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option></select>
            </div>
            <div class="form-group" style="margin:0;"><label class="form-label">To Month</label>
              <select class="form-control" id="trTo"><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option></select>
            </div>
          </div>
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group" style="margin:0;"><label class="form-label">Year</label><select class="form-control" id="trYear"></select></div>
            <div class="form-group" style="margin:0;"><label class="form-label">Member</label><select class="form-control" id="trUser"><option value="">All Members</option></select></div>
          </div>
          <div class="form-row" style="margin-bottom:0;">
            <div class="form-group" style="margin:0;"><label class="form-label">Project</label><select class="form-control" id="trProject"><option value="">All Projects</option></select></div>
            <div class="form-group" style="margin:0;"><label class="form-label">View</label>
              <select class="form-control" id="trView"><option value="both">Both</option><option value="person">By Person</option><option value="project">By Project</option></select>
            </div>
          </div>
          <div style="margin-top:14px;display:flex;gap:10px;">
            <button class="btn btn-primary" id="trRunBtn">Generate Report</button>
            <button class="btn btn-success" id="trPdfBtn" style="display:none;">‚¨áÔ∏è Export PDF</button>
          </div>
        </div>
        <div id="trOutput" style="display:none;">
          <div class="stats-grid" id="trStats"></div>
          <div style="background:white;border-radius:10px;padding:14px 18px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,0.06);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
            <div><div style="font-weight:700;font-size:15px;" id="trTitle"></div><div style="font-size:12px;color:#718096;margin-top:2px;" id="trSubtitle"></div></div>
            <button class="btn btn-success btn-sm" id="trPdfBtn2">‚¨áÔ∏è Export PDF</button>
          </div>
          <div id="trPersonSec" class="card" style="padding:0;overflow:hidden;"><div style="padding:12px 18px;border-bottom:1px solid #e2e8f0;font-weight:700;">üë§ By Person</div><div style="overflow-x:auto;padding:14px;"><div id="trPersonTbl"></div></div></div>
          <div id="trProjSec" class="card" style="padding:0;overflow:hidden;"><div style="padding:12px 18px;border-bottom:1px solid #e2e8f0;font-weight:700;">üìÅ By Project & Phase</div><div style="overflow-x:auto;padding:14px;"><div id="trProjTbl"></div></div></div>
          <div class="card" style="padding:0;overflow:hidden;"><div style="padding:12px 18px;border-bottom:1px solid #e2e8f0;font-weight:700;">üìã Detail Log</div><div style="overflow-x:auto;padding:14px;"><div id="trDetailTbl"></div></div></div>
        </div>
      </div>

      <!-- LEAVE -->
      <div class="page" id="page-leaves">
        <h2 class="page-title">üå¥ Leave Management</h2>
        <div class="balance-grid" id="leaveBalance"></div>
        <div class="section-header">
          <h3 style="font-weight:700;">My Applications</h3>
          <button class="btn btn-primary" id="applyLeaveBtn">+ Apply</button>
        </div>
        <div id="myLeaveList"></div>
      </div>

      <!-- APPROVALS -->
      <div class="page" id="page-approvals">
        <h2 class="page-title">‚úÖ Pending Approvals</h2>
        <div id="approvalsList"></div>
      </div>

      <!-- MANAGE -->
      <div class="page" id="page-manage">
        <h2 class="page-title">‚öôÔ∏è Manage</h2>
        <div class="manage-grid">
          <div class="card">
            <div class="card-title">üë• Team Members</div>
            <div class="add-row" style="flex-wrap:wrap;">
              <input class="form-control" id="newUserName" placeholder="Full name" style="min-width:120px;">
              <input class="form-control" id="newUserEmail" placeholder="Email" style="min-width:160px;">
              <input class="form-control" id="newUserPass" placeholder="Password" style="min-width:120px;">
              <button class="btn btn-primary btn-sm" id="addUserBtn">Add</button>
            </div>
            <div id="usersList"></div>
          </div>
          <div class="card">
            <div class="card-title">üè¢ Clients</div>
            <div class="add-row">
              <input class="form-control" id="newClient" placeholder="New client name">
              <button class="btn btn-primary btn-sm" id="addClientBtn">Add</button>
            </div>
            <div id="clientsList"></div>
          </div>
        </div>
        <div class="card" style="margin-top:16px;">
          <div class="card-title">üè∑Ô∏è Job Typologies</div>
          <div class="add-row">
            <input class="form-control" id="newTypology" placeholder="New typology name">
            <button class="btn btn-primary btn-sm" id="addTypologyBtn">Add</button>
          </div>
          <div id="typologyList"></div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- FLOATING TIMER -->
<div class="timer-widget" id="timerWidget" style="display:none;">
  <div class="timer-handle" id="timerHandle"><span>‚è±Ô∏è Live Timer</span><span id="timerRunningLabel" style="color:#38a169;font-size:10px;"></span></div>
  <div class="timer-body">
    <div class="timer-display" id="timerDisplay">00:00:00</div>
    <div class="timer-status" id="timerStatus">Timer ready</div>
    <div class="timer-project" id="timerProject" style="display:none;"></div>
    <div id="timerPreStart"><button class="btn btn-success" style="width:100%;" id="timerStartBtn">‚ñ∂ Start Timer</button></div>
    <div id="timerRunning" style="display:none;">
      <button class="btn btn-primary" id="timerStopBtn" style="width:100%;">‚èπ Stop & Save</button>
    </div>
  </div>
</div>

<!-- MODALS -->

<!-- Plan Entry Modal -->
<div class="modal-backdrop" id="planModal">
  <div class="modal-box">
    <div class="modal-head"><h3 id="planModalTitle">Assign Work</h3><button class="close-btn" onclick="closeModal('planModal')">√ó</button></div>
    <div class="form-group"><label class="form-label">Project *</label><select class="form-control" id="planProject"></select></div>
    <div class="form-group"><label class="form-label">Phase</label><select class="form-control" id="planPhase"></select></div>
    <div class="form-group"><label class="form-label">Job Type</label><select class="form-control" id="planTypology"></select></div>
    <div class="form-group"><label class="form-label">Description</label><textarea class="form-control" id="planDesc" placeholder="What needs to be done..."></textarea></div>
    <div class="form-group"><label class="form-label">Type</label>
      <select class="form-control" id="planType"><option value="planned">Planned</option><option value="emergency">Emergency / Unplanned</option></select>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button class="btn btn-primary" id="savePlanBtn">Save</button>
      <button class="btn btn-ghost" onclick="closeModal('planModal')">Cancel</button>
      <button class="btn btn-danger btn-sm" id="deletePlanBtn" style="margin-left:auto;display:none;">Delete</button>
    </div>
  </div>
</div>

<!-- Timer Description Modal -->
<div class="modal-backdrop" id="timerDescModal">
  <div class="modal-box" style="max-width:480px;">
    <div class="modal-head"><h3>‚è±Ô∏è Timer Stopped</h3><button class="close-btn" onclick="closeModal('timerDescModal')">√ó</button></div>
    <div style="background:#f0fff4;border:2px solid #9ae6b4;border-radius:10px;padding:16px;margin-bottom:16px;text-align:center;">
      <div style="font-size:24px;font-weight:800;color:#38a169;" id="timerDescTime">1h 23m</div>
      <div style="font-size:13px;color:#718096;margin-top:4px;" id="timerDescProject"></div>
    </div>
    <div class="form-group">
      <label class="form-label">What did you work on? *</label>
      <textarea class="form-control" id="timerDescText" placeholder="Describe what you did..." rows="4"></textarea>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary" id="saveTimerDescBtn">üíæ Save Log</button>
      <button class="btn btn-ghost" id="cancelTimerDescBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Time Log Modal -->
<div class="modal-backdrop" id="logModal">
  <div class="modal-box">
    <div class="modal-head"><h3>Log Time</h3><button class="close-btn" onclick="closeModal('logModal')">√ó</button></div>
    <!-- Productive / Non-productive -->
    <div class="form-group" id="prodTypeGroup">
      <label class="form-label">Productivity Type</label>
      <div class="radio-group">
        <label><input type="radio" name="logProd" value="productive" id="logProdYes" checked> Productive</label>
        <label><input type="radio" name="logProd" value="non-productive" id="logProdNo"> Non-Productive</label>
      </div>
    </div>
    <!-- Productive fields -->
    <div id="logProdFields">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Project *</label><select class="form-control" id="logProject"><option value="">Select...</option></select></div>
        <div class="form-group"><label class="form-label">Phase *</label><select class="form-control" id="logPhase"><option value="">Select project first</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">Job Type *</label><select class="form-control" id="logTypology"><option value="">Select...</option></select></div>
    </div>
    <!-- Non-productive fields -->
    <div id="logNonProdFields" style="display:none;">
      <div class="form-group"><label class="form-label">Activity *</label>
        <select class="form-control" id="logActivity">
          <option value="">Select activity...</option>
          <option value="Lunch Break">üçΩÔ∏è Lunch Break</option>
          <option value="Tea Break">‚òï Tea Break</option>
          <option value="Internal Meeting">üë• Internal Meeting</option>
          <option value="Team Discussion">üí¨ Team Discussion</option>
          <option value="Vendor Meeting">ü§ù Vendor Meeting</option>
          <option value="Client Call">üìû Client Call (Non-Project)</option>
          <option value="Administrative Work">üìã Administrative Work</option>
          <option value="Email & Communication">üìß Email & Communication</option>
          <option value="Training/Learning">üìö Training/Learning</option>
          <option value="Travel">üöó Travel</option>
          <option value="Personal Break">üö∂ Personal Break</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="form-group" id="logActivityOtherDiv" style="display:none;">
        <label class="form-label">Specify Other Activity</label>
        <input type="text" class="form-control" id="logActivityOther" placeholder="Describe the activity...">
      </div>
    </div>
    <div class="form-group"><label class="form-label">Date *</label><input type="date" class="form-control" id="logDate"></div>
    <!-- Time method -->
    <div class="form-group" id="timeMethodGroup">
      <label class="form-label">Time Entry</label>
      <div class="radio-group">
        <label id="tmDurLabel"><input type="radio" name="timeMeth" value="duration" id="tmDur" checked> Duration</label>
        <label id="tmSELabel"><input type="radio" name="timeMeth" value="startend" id="tmSE"> Start/End</label>
        <label><input type="radio" name="timeMeth" value="timer" id="tmTmr"> Live Timer</label>
      </div>
    </div>
    <div id="durSection">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Hours</label><input type="number" class="form-control" id="logH" min="0" max="23" value="0"></div>
        <div class="form-group"><label class="form-label">Minutes</label><select class="form-control" id="logM"><option value="0">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option></select></div>
      </div>
    </div>
    <div id="seSection" style="display:none;">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Start</label><input type="time" class="form-control" id="logS"></div>
        <div class="form-group"><label class="form-label">End</label><input type="time" class="form-control" id="logE"></div>
      </div>
      <div class="info-box" id="sePreview">Duration: ‚Äî</div>
    </div>
    <div id="tmrSection" style="display:none;">
      <div style="background:#f0fff4;border:2px solid #9ae6b4;border-radius:10px;padding:14px;text-align:center;">
        <div style="font-size:34px;font-weight:800;color:#38a169;font-variant-numeric:tabular-nums;" id="mTimerDisp">00:00:00</div>
        <div style="font-size:11px;color:#718096;margin:4px 0 10px;" id="mTimerStatus">Not started</div>
        <div style="display:flex;gap:8px;justify-content:center;">
          <button type="button" class="btn btn-success btn-sm" id="mTimerStart">‚ñ∂ Start</button>
          <button type="button" class="btn btn-warning btn-sm" id="mTimerPause" style="display:none;">‚è∏ Pause</button>
          <button type="button" class="btn btn-ghost btn-sm" id="mTimerReset" style="display:none;">‚Ü∫ Reset</button>
        </div>
      </div>
    </div>
    <div class="form-group" style="margin-top:12px;"><label class="form-label">Description *</label><textarea class="form-control" id="logDesc" placeholder="What was done..."></textarea></div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button class="btn btn-primary" id="saveLogBtn">Save Log</button>
      <button class="btn btn-ghost" onclick="closeModal('logModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- Project Modal (admin) -->
<div class="modal-backdrop" id="projectModal">
  <div class="modal-box wide">
    <div class="modal-head"><h3 id="projModalTitle">New Project</h3><button class="close-btn" onclick="closeModal('projectModal')">√ó</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Project Name *</label><input type="text" class="form-control" id="pName"></div>
      <div class="form-group"><label class="form-label">Client *</label>
        <select class="form-control" id="pClientSelect">
          <option value="">Select client...</option>
        </select>
      </div>
    </div>
    <div class="form-group" id="pNewClientDiv" style="display:none;">
      <label class="form-label">New Client Name *</label>
      <input type="text" class="form-control" id="pNewClient" placeholder="Enter new client name">
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Start Date</label><input type="date" class="form-control" id="pStart"></div>
      <div class="form-group"><label class="form-label">End Date</label><input type="date" class="form-control" id="pEnd"></div>
    </div>
    <div style="font-weight:700;font-size:14px;margin-bottom:12px;margin-top:4px;">‚è±Ô∏è Phase Budgets (hours)</div>
    <div id="phaseBudgetFields"></div>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button class="btn btn-primary" id="saveProjBtn">Save Project</button>
      <button class="btn btn-ghost" onclick="closeModal('projectModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- Leave Modal -->
<div class="modal-backdrop" id="leaveModal">
  <div class="modal-box">
    <div class="modal-head"><h3>Apply for Leave</h3><button class="close-btn" onclick="closeModal('leaveModal')">√ó</button></div>
    <div class="form-group"><label class="form-label">Leave Type *</label><select class="form-control" id="lType"><option value="">Select...</option><option value="medical">Medical Leave</option><option value="casual">Casual Leave</option></select></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Start *</label><input type="date" class="form-control" id="lStart"></div>
      <div class="form-group"><label class="form-label">End *</label><input type="date" class="form-control" id="lEnd"></div>
    </div>
    <div class="info-box" id="lDayInfo">Working days: ‚Äî</div>
    <div class="form-group"><label class="form-label">Reason *</label><textarea class="form-control" id="lReason"></textarea></div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary" id="submitLeaveBtn">Submit</button>
      <button class="btn btn-ghost" onclick="closeModal('leaveModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- Holiday Modal -->
<div class="modal-backdrop" id="holidayModal">
  <div class="modal-box" style="max-width:480px;">
    <div class="modal-head"><h3>üìÖ Add Holiday</h3><button class="close-btn" onclick="closeModal('holidayModal')">√ó</button></div>
    <div class="form-group"><label class="form-label">Holiday Name *</label><input type="text" class="form-control" id="holName" placeholder="e.g., Diwali, Christmas"></div>
    <div class="form-group"><label class="form-label">Date *</label><input type="date" class="form-control" id="holDate"></div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary" id="saveHolidayBtn">Save Holiday</button>
      <button class="btn btn-ghost" onclick="closeModal('holidayModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- View Holidays Modal -->
<div class="modal-backdrop" id="viewHolidaysModal">
  <div class="modal-box">
    <div class="modal-head"><h3>üìÖ Holidays</h3><button class="close-btn" onclick="closeModal('viewHolidaysModal')">√ó</button></div>
    <div id="holidaysList"></div>
  </div>
</div>

<<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBi_OD42znfsYZerQ_c6RWfLIPD_GropBE",
  authDomain: "square-office-management.firebaseapp.com",
  projectId: "square-office-management",
  storageBucket: "square-office-management.firebasestorage.app",
  messagingSenderId: "99247930577",
  appId: "1:99247930577:web:4f5137e9476349582319f0"
};

// Initialize Firebase and Firestore
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Initialize Firebase
const app = initializeApp(firebaseConfig);
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS & DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PHASES = ['Schematic Design','Final Design','Construction Documents','Material Selection & Coordination','Site Supervision','Project Management'];
const MONTHS_L = ['January','February','March','April','May','June','July','August','September','October','November','December'];

let currentUser = null;

let users = [
  {id:'u1',name:'Admin User',   email:'admin@square.com',  password:'admin123', isAdmin:true,  medLeft:12,casLeft:5},
  {id:'u2',name:'Rajesh Kumar', email:'rajesh@square.com', password:'rajesh123',isAdmin:false, medLeft:12,casLeft:5},
  {id:'u3',name:'Priya Sharma', email:'priya@square.com',  password:'priya123', isAdmin:false, medLeft:12,casLeft:5},
  {id:'u4',name:'Amit Patel',   email:'amit@square.com',   password:'amit123',  isAdmin:false, medLeft:12,casLeft:5},
  {id:'u5',name:'Sonia Verma',  email:'sonia@square.com',  password:'sonia123', isAdmin:false, medLeft:12,casLeft:5},
];

// Job typologies (standard, same for all projects)
let typologies = [
  'Schematic Design ‚Äì Concept Development',
  'Schematic Design ‚Äì Client Presentation',
  'Final Design ‚Äì Detailed Drawings',
  'Final Design ‚Äì 3D Visualisation',
  'Construction Documents ‚Äì Floor Plans',
  'Construction Documents ‚Äì Sections & Elevations',
  'Construction Documents ‚Äì Details',
  'Material Selection ‚Äì Research',
  'Material Selection ‚Äì Vendor Coordination',
  'Site Supervision ‚Äì Site Visit',
  'Site Supervision ‚Äì Progress Report',
  'Project Management ‚Äì Coordination',
  'Project Management ‚Äì Client Meeting',
  'Project Management ‚Äì Internal Review',
];

// Clients list
let clients = ['Acme Corp', 'Tech Solutions', 'Global Industries', 'Startup Inc', 'Enterprise Co'];

// Projects with phase budgets
let projectsData = [
  { id:'p1', name:'Villa Interior ‚Äì Phase 1', client:'Acme Corp', startDate:'2026-01-01', endDate:'2026-06-30',
    phases:{ 'Schematic Design':40, 'Final Design':80, 'Construction Documents':120, 'Material Selection & Coordination':30, 'Site Supervision':20, 'Project Management':40 }},
  { id:'p2', name:'Office Fit-Out', client:'Tech Solutions', startDate:'2026-02-01', endDate:'2026-05-31',
    phases:{ 'Schematic Design':20, 'Final Design':40, 'Construction Documents':60, 'Material Selection & Coordination':20, 'Site Supervision':15, 'Project Management':25 }},
];

let planEntries   = [];   // weekly planner entries
let timeLogs      = [];   // time log entries
let holidays      = [];   // custom holidays

// Debug function - call from console: checkLogs()
window.checkLogs = function() {
  console.log('Total timeLogs:', timeLogs.length);
  console.log('timeLogs array:', timeLogs);
  timeLogs.forEach((log, i) => {
    console.log(`Log ${i}:`, log);
  });
};
let leaveRequests = [];
let changeRequests= [];

let currentWeek  = getMonday(new Date());
let planWeek     = getMonday(new Date());
let editPlanId   = null;
let editPlanUser = null;
let editPlanDay  = null;

// Timer state
let timerInterval=null, timerStartedAt=null, timerPausedMs=0, timerRunning=false, timerLinkedPlan=null;
let mTimerInterval=null, mTimerStartedAt=null, mTimerPausedMs=0, mTimerRunning=false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA PERSISTENCE (FIREBASE FIRESTORE)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveData() {
  try {
    const dataToSave = {
      users, clients, typologies, projectsData, planEntries, timeLogs, leaveRequests, changeRequests, holidays
    };
    // Save everything to a single document called 'squareDB' in the 'companyData' collection
    await setDoc(doc(db, "companyData", "squareDB"), dataToSave);
    console.log('‚úÖ Data saved to Firebase!');
  } catch(e) {
    console.error('‚ùå Error saving data to Firebase:', e);
  }
}

async function loadData() {
  try {
    const docSnap = await getDoc(doc(db, "companyData", "squareDB"));
    if (docSnap.exists()) {
      const data = docSnap.data();
      users = data.users || users;
      clients = data.clients || clients;
      typologies = data.typologies || typologies;
      projectsData = data.projectsData || projectsData;
      planEntries = data.planEntries || [];
      timeLogs = data.timeLogs || [];
      leaveRequests = data.leaveRequests || [];
      changeRequests = data.changeRequests || [];
      holidays = data.holidays || [];
      console.log('‚úÖ Data loaded from Firebase!');
    } else {
      console.log("No data found in Firebase. Creating initial database...");
      await saveData(); // Push the default code arrays to Firebase for the first time
    }
  } catch(e) {
    console.error('‚ùå Error loading data from Firebase:', e);
  }
}

function loadData() {
  try {
    const saved = localStorage.getItem('squareData');
    if(saved) {
      const data = JSON.parse(saved);
      users = data.users || users;
      clients = data.clients || clients;
      typologies = data.typologies || typologies;
      projectsData = data.projectsData || projectsData;
      planEntries = data.planEntries || [];
      timeLogs = data.timeLogs || [];
      leaveRequests = data.leaveRequests || [];
      changeRequests = data.changeRequests || [];
      holidays = data.holidays || [];
      console.log('Data loaded from localStorage');
    }
  } catch(e) {
    console.error('Error loading data:', e);
  }
}

// Load data on startup
loadData();

// Auto-login if session exists
function autoLogin(){
  try {
    const session = localStorage.getItem('currentSession');
    if(session) {
      const {userId} = JSON.parse(session);
      const user = users.find(u => u.id === userId);
      if(user) {
        currentUser = user;
        document.getElementById('loginScreen').style.display='none';
        document.getElementById('mainApp').style.display='flex';
        document.getElementById('topbarName').textContent=user.name;
        document.getElementById('adminBadge').style.display=user.isAdmin?'inline-block':'none';
        document.querySelectorAll('.admin-only').forEach(el=>el.style.display=user.isAdmin?'flex':'none');
        setTimeout(() => {
          initTimeReport(); renderDashboard(); updateApprovalBadge();
        }, 100);
        console.log('Auto-login successful:', user.name);
      }
    }
  } catch(e) {
    console.error('Auto-login failed:', e);
  }
}

// Startup Sequence: Load from Firebase FIRST, then try to auto-login
loadData().then(() => {
  autoLogin();
});

// Auto-save data whenever it changes
window.autoSave = function() {
  saveData();
};
// Auto-save data whenever it changes
function autoSave() {
  saveData();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let notifications = [];

function addNotification(title, message, type='info') {
  const id = genId();
  notifications.push({ id, title, message, type, timestamp: Date.now(), read: false });
  showNotificationToast(title, message, type);
  saveData();
}

function showNotificationToast(title, message, type) {
  const toast = document.createElement('div');
  toast.className = 'notification-toast ' + type;
  toast.innerHTML = `<div class="notif-title">${title}</div><div class="notif-msg">${message}</div>`;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 10);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 5000);
}

function checkNotifications() {
  const today = fmt(new Date());
  const now = new Date();
  
  // Check if anyone hasn't logged time today
  users.forEach(user => {
    if(user.isAdmin) return; // Skip admin
    const todayLogs = timeLogs.filter(l => l.userId === user.id && l.date === today);
    const todayPlans = planEntries.filter(p => p.userId === user.id && p.date === today);
    
    // If it's past 2 PM and they have plans but no logs
    if(now.getHours() >= 14 && todayPlans.length > 0 && todayLogs.length === 0) {
      const lastNotif = notifications.find(n => n.message.includes(user.name) && n.message.includes('log time'));
      const lastNotifTime = lastNotif ? lastNotif.timestamp : 0;
      // Only notify once per day
      if(Date.now() - lastNotifTime > 24*60*60*1000) {
        addNotification('‚è±Ô∏è Time Log Reminder', `${user.name} hasn't logged time today`, 'warning');
      }
    }
  });
  
  // Check project phase budgets
  projectsData.forEach(proj => {
    Object.entries(proj.phases).forEach(([phase, budget]) => {
      if(budget === 0) return;
      const used = phaseLoggedMins(proj.id, phase) / 60;
      const pct = (used / budget) * 100;
      
      // Alert at 80% and 100%
      if(pct >= 80 && pct < 100) {
        const key = `${proj.id}-${phase}-80`;
        if(!notifications.find(n => n.message.includes(key))) {
          addNotification('‚ö†Ô∏è Budget Alert', `${proj.name} - ${phase}: ${pct.toFixed(0)}% used (${key})`, 'warning');
        }
      } else if(pct >= 100) {
        const key = `${proj.id}-${phase}-100`;
        if(!notifications.find(n => n.message.includes(key))) {
          addNotification('üö® Budget Exceeded', `${proj.name} - ${phase}: Budget exceeded! (${key})`, 'error');
        }
      }
    });
  });
  
  // Check project deadlines (within 7 days)
  projectsData.forEach(proj => {
    if(!proj.endDate) return;
    const daysLeft = Math.ceil((new Date(proj.endDate) - now) / (1000*60*60*24));
    if(daysLeft <= 7 && daysLeft > 0) {
      const key = `${proj.id}-deadline-${daysLeft}`;
      if(!notifications.find(n => n.message.includes(key))) {
        addNotification('üìÖ Deadline Approaching', `${proj.name} ends in ${daysLeft} days (${key})`, 'info');
      }
    }
  });
}

// Check notifications every 30 minutes
setInterval(checkNotifications, 30 * 60 * 1000);
// Check on load
setTimeout(checkNotifications, 5000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genId(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,5); }
function fmt(d){ return new Date(d).toISOString().split('T')[0]; }
function fmtD(s){ return new Date(s).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}); }
function getMonday(d){ const dt=new Date(d),day=dt.getDay(); dt.setDate(dt.getDate()-day+(day===0?-6:1)); return dt; }
function addDays(d,n){ const r=new Date(d); r.setDate(r.getDate()+n); return r; }
function isSunday(d){ return new Date(d).getDay()===0; }
function is24Sat(d){ const dt=new Date(d); if(dt.getDay()!==6) return false; return [2,4].includes(Math.ceil(dt.getDate()/7)); }
function isHoliday(d){ 
  if(isSunday(d) || is24Sat(d)) return true;
  const ds = fmt(d);
  return holidays.some(h => h.date === ds);
}
function workDays(s,e){ let c=0,cur=new Date(s),end=new Date(e); while(cur<=end){if(!isHoliday(cur))c++; cur=addDays(cur,1);} return c; }
function minsToHM(m){ return `${Math.floor(m/60)}h ${String(m%60).padStart(2,'0')}m`; }
function hrsToHM(h){ return minsToHM(Math.round(h*60)); }
function hhmm(t){ const[h,m]=t.split(':').map(Number); return h*60+m; }
function secsToHMS(s){ return `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }
function getElapsed(startedAt, pausedMs){ return Math.floor((Date.now()-startedAt-pausedMs)/1000); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function openModal(id){ document.getElementById(id).classList.add('open'); }
function updateApprovalBadge(){
  const n=changeRequests.filter(r=>r.status==='pending').length+leaveRequests.filter(l=>l.status==='pending').length;
  const b=document.getElementById('approvalBadge'); b.style.display=n>0?'inline-block':'none'; b.textContent=n;
}

// Get logged hours for a project phase
function phaseLoggedMins(projectId, phaseName){
  return timeLogs.filter(l=>l.projectId===projectId && l.phase===phaseName)
                 .reduce((s,l)=>s+l.durationMins,0);
}
function projectLoggedMins(projectId){
  return timeLogs.filter(l=>l.projectId===projectId).reduce((s,l)=>s+l.durationMins,0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN / LOGOUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('loginBtn').addEventListener('click', doLogin);
document.getElementById('loginPassword').addEventListener('keypress', e=>{ if(e.key==='Enter') doLogin(); });
function doLogin(){
  const email=document.getElementById('loginEmail').value.trim().toLowerCase();
  const pass=document.getElementById('loginPassword').value.trim();
  console.log('Login attempt - Email:', email, 'Pass:', pass);
  console.log('Available users:', users.map(u => ({email: u.email, password: u.password})));
  const user=users.find(u=>u.email.toLowerCase()===email&&u.password===pass);
  console.log('User found:', user);
  const err=document.getElementById('loginError');
  if(user){
    currentUser=user; err.style.display='none';
    // Save session to localStorage
    localStorage.setItem('currentSession', JSON.stringify({userId: user.id}));
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('mainApp').style.display='flex';
    document.getElementById('topbarName').textContent=user.name;
    document.getElementById('adminBadge').style.display=user.isAdmin?'inline-block':'none';
    document.querySelectorAll('.admin-only').forEach(el=>el.style.display=user.isAdmin?'flex':'none');
    initTimeReport(); renderDashboard(); updateApprovalBadge();
  } else { 
    err.style.display='block'; 
    err.textContent='Invalid email or password.';
    console.log('Login failed - no matching user found');
  }
}
document.getElementById('logoutBtn').addEventListener('click',()=>{
  currentUser=null;
  localStorage.removeItem('currentSession');
  document.getElementById('mainApp').style.display='none';
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('loginEmail').value='';
  document.getElementById('loginPassword').value='';
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.nav-item[data-page]').forEach(item=>{
  item.addEventListener('click',function(){
    const page=this.dataset.page;
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    this.classList.add('active');
    document.getElementById('page-'+page).classList.add('active');
    if(page==='dashboard')  renderDashboard();
    if(page==='planner')    renderPlanner();
    if(page==='timelog')    renderTimeLog();
    if(page==='projects')   renderProjectsBudget();
    if(page==='timereport') initTimeReport();
    if(page==='leaves')     renderLeaves();
    if(page==='approvals')  renderApprovals();
    if(page==='manage')     renderManage();
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('prevWeek').addEventListener('click',()=>{ currentWeek=addDays(currentWeek,-7); renderDashboard(); });
document.getElementById('nextWeek').addEventListener('click',()=>{ currentWeek=addDays(currentWeek,7);  renderDashboard(); });

function renderDashboard(){
  // Calculate analytics for current month
  const now = new Date();
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();
  const monthLogs = timeLogs.filter(l => {
    const d = new Date(l.date);
    return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
  });
  
  const totalHours = monthLogs.reduce((s,l) => s + l.durationMins, 0) / 60;
  const prodHours = monthLogs.filter(l => l.productive).reduce((s,l) => s + l.durationMins, 0) / 60;
  const utilization = totalHours > 0 ? ((prodHours / totalHours) * 100).toFixed(0) : 0;
  
  // Active projects with budget status
  const activeProjects = projectsData.length;
  let overBudgetCount = 0;
  projectsData.forEach(proj => {
    Object.entries(proj.phases).forEach(([phase, budget]) => {
      if(budget > 0) {
        const used = phaseLoggedMins(proj.id, phase) / 60;
        if(used >= budget) overBudgetCount++;
      }
    });
  });
  
  // Team utilization
  const activeUsers = users.filter(u => !u.isAdmin).length;
  const avgHoursPerPerson = activeUsers > 0 ? (totalHours / activeUsers).toFixed(1) : 0;
  
  // Render analytics cards
  document.getElementById('dashAnalytics').innerHTML = `
    <div class="stat-card"><div class="stat-num">${totalHours.toFixed(1)}h</div><div class="stat-lbl">Total Hours (This Month)</div></div>
    <div class="stat-card g"><div class="stat-num">${utilization}%</div><div class="stat-lbl">Productive Utilization</div></div>
    <div class="stat-card o"><div class="stat-num">${activeProjects}</div><div class="stat-lbl">Active Projects</div></div>
    <div class="stat-card ${overBudgetCount > 0 ? 'r' : 'p'}"><div class="stat-num">${overBudgetCount}</div><div class="stat-lbl">Phases Over Budget</div></div>
    <div class="stat-card"><div class="stat-num">${avgHoursPerPerson}h</div><div class="stat-lbl">Avg Hours/Person</div></div>
  `;
  
  // Render calendar
  const days=[]; for(let i=0;i<7;i++) days.push(addDays(currentWeek,i));
  document.getElementById('weekLabel').textContent='Week of '+currentWeek.toLocaleDateString('en-IN',{month:'short',day:'numeric',year:'numeric'});
  const grid=document.getElementById('calGrid'); grid.innerHTML='';
  const dn=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const head=document.createElement('div'); head.className='cal-head';
  head.innerHTML='<div class="cal-head-cell">Member</div>'+dn.map((d,i)=>{
    const dt=days[i],hol=isHoliday(dt),tod=fmt(dt)===fmt(new Date());
    return `<div class="cal-head-cell" style="${hol?'color:#e53e3e;background:#fff5f5;':''}${tod?'color:#2b6cb0;background:#ebf4ff;font-weight:800;':''}">${d}<br><small>${dt.getDate()}/${dt.getMonth()+1}</small></div>`;
  }).join(''); grid.appendChild(head);

  users.forEach(user=>{
    const row=document.createElement('div'); row.className='cal-row';
    const nc=document.createElement('div'); nc.className='cal-name'; nc.textContent=user.name; row.appendChild(nc);
    days.forEach(day=>{
      const ds=fmt(day),cell=document.createElement('div'); cell.className='cal-cell'+(fmt(day)===fmt(new Date())?' today':'')+(isHoliday(day)?' holiday':'');
      // Leave
      const lv=leaveRequests.find(l=>l.userId===user.id&&l.status==='approved'&&ds>=l.startDate&&ds<=l.endDate);
      if(lv){ const c=document.createElement('div'); c.className='chip chip-leave'; c.textContent=lv.type==='medical'?'üè• Medical':'üå¥ Casual'; cell.appendChild(c); }
      // Planner entries
      planEntries.filter(p=>p.userId===user.id&&p.date===ds).forEach(pl=>{
        const c=document.createElement('div'); c.className=`chip chip-task ${pl.type}`;
        c.textContent=`${pl.type==='emergency'?'üö®':'üìã'} ${pl.project}`;
        c.title=pl.desc; cell.appendChild(c);
      });
      // Time logs
      timeLogs.filter(l=>l.userId===user.id&&l.date===ds).forEach(lg=>{
        const c=document.createElement('div'); c.className='chip chip-log';
        c.textContent=`‚è± ${minsToHM(lg.durationMins)} ${lg.projectName||lg.activity||''}`;
        cell.appendChild(c);
      });
      row.appendChild(cell);
    });
    grid.appendChild(row);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HOLIDAY MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('dashAddHoliday').addEventListener('click', () => {
  document.getElementById('holName').value = '';
  document.getElementById('holDate').value = '';
  openModal('holidayModal');
});

document.getElementById('saveHolidayBtn').addEventListener('click', () => {
  const name = document.getElementById('holName').value.trim();
  const date = document.getElementById('holDate').value;
  if(!name || !date) { alert('Enter holiday name and date'); return; }
  
  if(holidays.find(h => h.date === date)) {
    alert('Holiday already exists for this date');
    return;
  }
  
  holidays.push({ id: genId(), name, date });
  holidays.sort((a,b) => new Date(a.date) - new Date(b.date));
  autoSave();
  closeModal('holidayModal');
  renderDashboard();
  alert('‚úÖ Holiday added: ' + name);
});

document.getElementById('dashViewHolidays').addEventListener('click', () => {
  const list = document.getElementById('holidaysList');
  if(holidays.length === 0) {
    list.innerHTML = '<p style="color:#718096;padding:20px;text-align:center;">No custom holidays added yet.</p>';
  } else {
    list.innerHTML = holidays.map(h => `
      <div class="list-item">
        <div><div style="font-weight:600;">${h.name}</div><div style="font-size:11px;color:#718096;">${fmtD(h.date)}</div></div>
        <button class="btn btn-danger btn-sm" onclick="deleteHoliday('${h.id}')">Delete</button>
      </div>
    `).join('');
  }
  openModal('viewHolidaysModal');
});

window.deleteHoliday = function(id) {
  if(!confirm('Delete this holiday?')) return;
  holidays = holidays.filter(h => h.id !== id);
  autoSave();
  document.getElementById('dashViewHolidays').click(); // Refresh list
  renderDashboard();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEEKLY PLANNER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('planPrev').addEventListener('click',()=>{ planWeek=addDays(planWeek,-7); renderPlanner(); });
document.getElementById('planNext').addEventListener('click',()=>{ planWeek=addDays(planWeek,7);  renderPlanner(); });

function renderPlanner(){
  const days=[]; for(let i=0;i<7;i++) days.push(addDays(planWeek,i)); // Mon‚ÄìSun (all 7 days)
  document.getElementById('planWeekLabel').textContent='Week of '+planWeek.toLocaleDateString('en-IN',{month:'short',day:'numeric',year:'numeric'});
  const grid=document.getElementById('plannerGrid'); grid.innerHTML='';
  const dn=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const head=document.createElement('div'); head.className='planner-head';
  head.innerHTML='<div class="planner-head-cell">Member</div>'+dn.map((d,i)=>{
    const dt=days[i],hol=isHoliday(dt),tod=fmt(dt)===fmt(new Date());
    return `<div class="planner-head-cell" style="${hol?'background:#fff5f5;color:#e53e3e;':''}${tod?'background:#ebf4ff;color:#2b6cb0;':''}">${d} <small>${dt.getDate()}/${dt.getMonth()+1}</small></div>`;
  }).join(''); grid.appendChild(head);

  users.forEach(user=>{
    const row=document.createElement('div'); row.className='planner-row';
    const nc=document.createElement('div'); nc.className='planner-name'; nc.textContent=user.name; row.appendChild(nc);
    days.forEach(day=>{
      const ds=fmt(day);
      const entries=planEntries.filter(p=>p.userId===user.id&&p.date===ds);
      const cell=document.createElement('div');
      cell.className='planner-cell'+(entries.length?' has-items':'')+(isHoliday(day)?' holiday':'');

      entries.forEach(pl=>{
        const c=document.createElement('div');
        c.className=`plan-chip ${pl.done?'done':pl.type}`;
        c.textContent=`${pl.type==='emergency'?'üö®':''}${pl.project}${pl.phase?' ¬∑ '+pl.phase.split(' ')[0]:''}`;
        c.title=pl.desc;
        c.onclick=(e)=>{ e.stopPropagation(); openPlanModal(user.id,ds,pl.id); };
        cell.appendChild(c);
      });

      // Click empty area to add (only if not a holiday)
      if(!isHoliday(day)) {
        cell.addEventListener('click',()=>openPlanModal(user.id,ds,null));
      }
      row.appendChild(cell);
    });
    grid.appendChild(row);
  });
}

function openPlanModal(userId,date,planId){
  editPlanId=planId; editPlanUser=userId; editPlanDay=date;
  const user=users.find(u=>u.id===userId);
  document.getElementById('planModalTitle').textContent=(planId?'Edit':'Assign Work')+' ‚Äî '+user.name+' ¬∑ '+fmtD(date);
  // Fill project dropdown
  const pSel=document.getElementById('planProject');
  pSel.innerHTML='<option value="">Select project...</option>'+projectsData.map(p=>`<option value="${p.id}">${p.name} (${p.client})</option>`).join('');
  // Fill typology
  const tSel=document.getElementById('planTypology');
  tSel.innerHTML='<option value="">Select typology...</option>'+typologies.map(t=>`<option value="${t}">${t}</option>`).join('');

  if(planId){
    const pl=planEntries.find(p=>p.id===planId);
    pSel.value=pl.projectId;
    updatePlanPhases(pl.projectId); document.getElementById('planPhase').value=pl.phase;
    document.getElementById('planTypology').value=pl.typology;
    document.getElementById('planDesc').value=pl.desc;
    document.getElementById('planType').value=pl.type;
    document.getElementById('deletePlanBtn').style.display='inline-block';
  } else {
    document.getElementById('planDesc').value='';
    document.getElementById('planType').value='planned';
    document.getElementById('deletePlanBtn').style.display='none';
    updatePlanPhases('');
  }
  openModal('planModal');
}

document.getElementById('planProject').addEventListener('change',function(){ updatePlanPhases(this.value); });
function updatePlanPhases(projId){
  const pSel=document.getElementById('planPhase');
  pSel.innerHTML='<option value="">Select phase...</option>'+PHASES.map(ph=>`<option value="${ph}">${ph}</option>`).join('');
}

document.getElementById('savePlanBtn').addEventListener('click',()=>{
  const projId=document.getElementById('planProject').value;
  if(!projId){ alert('Select a project'); return; }
  const proj=projectsData.find(p=>p.id===projId);
  const entry={
    id:editPlanId||genId(), userId:editPlanUser, date:editPlanDay,
    projectId:projId, project:proj.name, client:proj.client,
    phase:document.getElementById('planPhase').value,
    typology:document.getElementById('planTypology').value,
    desc:document.getElementById('planDesc').value.trim()||proj.name,
    estHours:0,
    type:document.getElementById('planType').value,
    done:false
  };
  if(editPlanId){ const i=planEntries.findIndex(p=>p.id===editPlanId); planEntries[i]=entry; }
  else planEntries.push(entry);
  autoSave();
  closeModal('planModal'); renderPlanner(); renderDashboard();
});

document.getElementById('deletePlanBtn').addEventListener('click',()=>{
  if(!confirm('Remove this plan entry?')) return;
  planEntries=planEntries.filter(p=>p.id!==editPlanId);
  closeModal('planModal'); renderPlanner(); renderDashboard();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TIME LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('addLogBtn').addEventListener('click',()=>{
  // Open modal in non-productive mode only (Option B enforcement)
  openLogModal();
  // Hide productivity type selector
  document.getElementById('prodTypeGroup').style.display='none';
  // Force non-productive mode
  document.getElementById('logProdNo').checked=true;
  document.getElementById('logProdFields').style.display='none';
  document.getElementById('logNonProdFields').style.display='block';
  // Only show Live Timer for non-productive
  document.getElementById('tmDurLabel').style.display='none';
  document.getElementById('tmSELabel').style.display='none';
  document.getElementById('tmTmr').checked=true;
  document.getElementById('durSection').style.display='none';
  document.getElementById('seSection').style.display='none';
  document.getElementById('tmrSection').style.display='block';
});
document.getElementById('tlFilterBtn').addEventListener('click', renderTimeLog);

// Productivity toggle
document.getElementById('logProdYes').addEventListener('change',()=>{
  document.getElementById('logProdFields').style.display='block';
  document.getElementById('logNonProdFields').style.display='none';
  // Show all time entry options for productive
  document.getElementById('tmDurLabel').style.display='inline-flex';
  document.getElementById('tmSELabel').style.display='inline-flex';
});
document.getElementById('logProdNo').addEventListener('change',()=>{
  document.getElementById('logProdFields').style.display='none';
  document.getElementById('logNonProdFields').style.display='block';
  // Only show Live Timer for non-productive
  document.getElementById('tmDurLabel').style.display='none';
  document.getElementById('tmSELabel').style.display='none';
  document.getElementById('tmTmr').checked=true;
  document.getElementById('durSection').style.display='none';
  document.getElementById('seSection').style.display='none';
  document.getElementById('tmrSection').style.display='block';
});

// Show/hide "Other" text field for non-productive activities
document.getElementById('logActivity').addEventListener('change',function(){
  document.getElementById('logActivityOtherDiv').style.display = this.value==='Other'?'block':'none';
});

// Time method toggle
document.getElementById('tmDur').addEventListener('change',()=>{ document.getElementById('durSection').style.display='block'; document.getElementById('seSection').style.display='none'; document.getElementById('tmrSection').style.display='none'; });
document.getElementById('tmSE').addEventListener('change',()=>{ document.getElementById('durSection').style.display='none'; document.getElementById('seSection').style.display='block'; document.getElementById('tmrSection').style.display='none'; });
document.getElementById('tmTmr').addEventListener('change',()=>{ document.getElementById('durSection').style.display='none'; document.getElementById('seSection').style.display='none'; document.getElementById('tmrSection').style.display='block'; });

// Start/end preview
['logS','logE'].forEach(id=>document.getElementById(id).addEventListener('change',()=>{
  const s=document.getElementById('logS').value,e=document.getElementById('logE').value;
  if(s&&e){ let m=hhmm(e)-hhmm(s); if(m<0)m+=1440; document.getElementById('sePreview').textContent='‚è±Ô∏è Duration: '+minsToHM(m); }
}));

// Project ‚Üí Phase cascading
document.getElementById('logProject').addEventListener('change',function(){
  const proj=projectsData.find(p=>p.id===this.value);
  const pSel=document.getElementById('logPhase');
  if(proj){ pSel.innerHTML='<option value="">Select phase...</option>'+Object.keys(proj.phases).map(ph=>`<option value="${ph}">${ph}</option>`).join(''); }
  else pSel.innerHTML='<option value="">Select project first</option>';
});

function openLogModal(preLinked=null){
  document.getElementById('logDate').value=fmt(new Date());
  document.getElementById('logH').value=0; document.getElementById('logM').value=0;
  document.getElementById('logS').value=''; document.getElementById('logE').value='';
  document.getElementById('logDesc').value=''; document.getElementById('logActivity').value='';
  document.getElementById('sePreview').textContent='Duration: ‚Äî';
  
  // Reset to productive mode by default
  document.getElementById('prodTypeGroup').style.display='block';
  document.getElementById('logProdYes').checked=true;
  document.getElementById('tmDur').checked=true;
  document.getElementById('logProdFields').style.display='block';
  document.getElementById('logNonProdFields').style.display='none';
  document.getElementById('durSection').style.display='block';
  document.getElementById('seSection').style.display='none';
  document.getElementById('tmrSection').style.display='none';
  
  // Show all time entry options
  document.getElementById('tmDurLabel').style.display='inline-flex';
  document.getElementById('tmSELabel').style.display='inline-flex';
  
  // Fill project
  document.getElementById('logProject').innerHTML='<option value="">Select...</option>'+projectsData.map(p=>`<option value="${p.id}">${p.name} (${p.client})</option>`).join('');
  if(preLinked){ document.getElementById('logProject').value=preLinked; document.getElementById('logProject').dispatchEvent(new Event('change')); }
  else document.getElementById('logPhase').innerHTML='<option value="">Select project first</option>';
  // Fill typology
  document.getElementById('logTypology').innerHTML='<option value="">Select...</option>'+typologies.map(t=>`<option value="${t}">${t}</option>`).join('');
  // Reset modal timer
  clearInterval(mTimerInterval); mTimerRunning=false; mTimerStartedAt=null; mTimerPausedMs=0;
  document.getElementById('mTimerDisp').textContent='00:00:00';
  document.getElementById('mTimerStatus').textContent='Not started';
  document.getElementById('mTimerStart').style.display='inline-block';
  document.getElementById('mTimerPause').style.display='none';
  document.getElementById('mTimerReset').style.display='none';
  openModal('logModal');
}

// Modal timer
document.getElementById('mTimerStart').addEventListener('click',()=>{
  mTimerStartedAt=Date.now(); mTimerPausedMs=0; mTimerRunning=true;
  document.getElementById('mTimerStart').style.display='none';
  document.getElementById('mTimerPause').style.display='inline-block';
  document.getElementById('mTimerReset').style.display='inline-block';
  document.getElementById('mTimerStatus').textContent='‚óè Recording...';
  mTimerInterval=setInterval(()=>{ document.getElementById('mTimerDisp').textContent=secsToHMS(getElapsed(mTimerStartedAt,mTimerPausedMs)); },1000);
});
document.getElementById('mTimerPause').addEventListener('click',function(){
  if(mTimerRunning){
    clearInterval(mTimerInterval); mTimerRunning=false;
    const elapsed=getElapsed(mTimerStartedAt,mTimerPausedMs);
    mTimerStartedAt=Date.now()-elapsed*1000; mTimerPausedMs=0;
    this.textContent='‚ñ∂ Resume'; document.getElementById('mTimerStatus').textContent='Paused';
  } else {
    mTimerStartedAt=Date.now()-parseInt(document.getElementById('mTimerDisp').textContent.split(':')[0])*3600*1000; mTimerPausedMs=0; mTimerRunning=true;
    this.textContent='‚è∏ Pause'; document.getElementById('mTimerStatus').textContent='‚óè Recording...';
    mTimerInterval=setInterval(()=>{ document.getElementById('mTimerDisp').textContent=secsToHMS(getElapsed(mTimerStartedAt,mTimerPausedMs)); },1000);
  }
});
document.getElementById('mTimerReset').addEventListener('click',()=>{
  clearInterval(mTimerInterval); mTimerRunning=false; mTimerStartedAt=null; mTimerPausedMs=0;
  document.getElementById('mTimerDisp').textContent='00:00:00'; document.getElementById('mTimerStatus').textContent='Reset';
  document.getElementById('mTimerStart').style.display='inline-block';
  document.getElementById('mTimerPause').style.display='none'; document.getElementById('mTimerPause').textContent='‚è∏ Pause';
  document.getElementById('mTimerReset').style.display='none';
});

document.getElementById('saveLogBtn').addEventListener('click', saveLog);
function saveLog(){
  const isProd=document.getElementById('logProdYes').checked;
  const isStartEnd=document.getElementById('tmSE').checked;
  const isTimer=document.getElementById('tmTmr').checked;
  const date=document.getElementById('logDate').value;
  if(!date){ alert('Select a date'); return; }

  let projectId='',projectName='',phase='',typology='',activity='';
  if(isProd){
    projectId=document.getElementById('logProject').value;
    phase=document.getElementById('logPhase').value;
    typology=document.getElementById('logTypology').value;
    if(!projectId||!phase||!typology){ alert('Select project, phase and job type'); return; }
    projectName=projectsData.find(p=>p.id===projectId)?.name||'';
  } else {
    activity=document.getElementById('logActivity').value.trim();
    if(!activity){ alert('Select an activity'); return; }
    if(activity==='Other'){
      const otherActivity=document.getElementById('logActivityOther').value.trim();
      if(!otherActivity){ alert('Specify the other activity'); return; }
      activity=otherActivity;
    }
  }

  let durationMins=0,startTime='',endTime='';
  if(isStartEnd){
    startTime=document.getElementById('logS').value; endTime=document.getElementById('logE').value;
    if(!startTime||!endTime){ alert('Enter start and end time'); return; }
    durationMins=hhmm(endTime)-hhmm(startTime); if(durationMins<0) durationMins+=1440;
  } else if(isTimer){
    const parts=document.getElementById('mTimerDisp').textContent.split(':').map(Number);
    durationMins=parts[0]*60+parts[1]+(parts[2]>=30?1:0);
    if(durationMins<=0){ durationMins=(parseInt(document.getElementById('logH').value)||0)*60+(parseInt(document.getElementById('logM').value)||0); }
  } else {
    durationMins=(parseInt(document.getElementById('logH').value)||0)*60+(parseInt(document.getElementById('logM').value)||0);
  }
  if(durationMins<=0){ alert('Duration must be > 0'); return; }

  let desc=document.getElementById('logDesc').value.trim();
  // Auto-fill description for non-productive if empty
  if(!isProd && !desc){
    desc=activity;
  }
  if(!desc){ alert('Add a description of what you did'); return; }

  timeLogs.push({ id:genId(), userId:currentUser.id, date, projectId, projectName, phase, typology, activity, durationMins, startTime, endTime, desc, productive:isProd, ts:Date.now() });
  autoSave();
  closeModal('logModal'); renderTimeLog(); renderProjectsBudget(); renderDashboard();
  alert('‚úÖ Logged: '+minsToHM(durationMins));
}

function renderTimeLog(){
  try {
    console.log('renderTimeLog called');
    console.log('timeLogs array:', timeLogs);
    console.log('timeLogs length:', timeLogs.length);
    
    const month=parseInt(document.getElementById('tlMonth').value);
    const projFilter=document.getElementById('tlProject').value;
    const typeFilter=document.getElementById('tlType').value;
    console.log('Filters - month:', month, 'project:', projFilter, 'type:', typeFilter);
    
    // Populate project filter
    document.getElementById('tlProject').innerHTML='<option value="">All Projects</option>'+projectsData.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    if(projFilter) document.getElementById('tlProject').value=projFilter;
    if(month<0&&!document.getElementById('tlMonth')._init){ document.getElementById('tlMonth').value=new Date().getMonth(); document.getElementById('tlMonth')._init=true; }

    let logs=timeLogs.filter(l=>currentUser.isAdmin||l.userId===currentUser.id);
    console.log('After user filter:', logs.length);
    const m=parseInt(document.getElementById('tlMonth').value);
    console.log('Month filter value:', m);
    if(m>=0) logs=logs.filter(l=>new Date(l.date).getMonth()===m);
    console.log('After month filter:', logs.length, 'logs:', logs);
    if(projFilter) logs=logs.filter(l=>l.projectId===projFilter);
    if(typeFilter) logs=logs.filter(l=>(typeFilter==='productive'?l.productive:!l.productive));
    logs=logs.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)||b.ts-a.ts);
    console.log('Final filtered logs:', logs);

    const total=logs.reduce((s,l)=>s+l.durationMins,0);
    document.getElementById('tlTotal').innerHTML=`${minsToHM(total)} total<span>${logs.length} entr${logs.length===1?'y':'ies'} ¬∑ current filter</span>`;

    const el=document.getElementById('timeLogList');
    if(!logs.length){ el.innerHTML='<p style="color:#718096;padding:20px;text-align:center;">No logs found. Click "+ Log Time" to start.</p>'; return; }
    el.innerHTML='';
    logs.forEach(log=>{
      const user=users.find(u=>u.id===log.userId);
      const el2=document.createElement('div'); el2.className='log-card';
      const projBadge=log.productive?`<strong>üìÅ ${log.projectName}</strong> ¬∑ ${log.phase} ¬∑ <span class="prod-tag">Productive</span>`:`<span class="nonprod-tag">Non-Productive</span> ${log.activity}`;
      el2.innerHTML=`
        <div class="log-body">
          <div class="log-time">‚è± ${minsToHM(log.durationMins)}</div>
          <div class="log-meta">${projBadge}${currentUser.isAdmin?` ¬∑ üë§ <strong>${user?.name||'?'}</strong>`:''}</div>
          ${log.typology?`<div style="font-size:11px;color:#718096;margin-bottom:3px;">üè∑Ô∏è ${log.typology}</div>`:''}
          <div class="log-desc">${log.desc}</div>
          ${log.startTime?`<div style="font-size:10px;color:#a0aec0;margin-top:2px;">üïê ${log.startTime}‚Äì${log.endTime}</div>`:''}
        </div>
        <div class="log-right">
          <div class="log-date">${fmtD(log.date)}</div>
        </div>`;
      el.appendChild(el2);
    });
    console.log('Rendered', logs.length, 'log cards');
  } catch(e) {
    console.error('ERROR in renderTimeLog:', e);
    alert('Error rendering time log: ' + e.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROJECTS & BUDGET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('addProjectBtn').addEventListener('click',()=>openProjectModal(null));

function renderProjectsBudget(){
  const el=document.getElementById('projectsBudgetList');
  if(!projectsData.length){ el.innerHTML='<p style="color:#718096;padding:20px;">No projects yet.</p>'; return; }
  el.innerHTML='';
  projectsData.forEach(proj=>{
    const totalBudget=Object.values(proj.phases).reduce((s,h)=>s+h,0);
    const loggedH=projectLoggedMins(proj.id)/60;
    const pct=totalBudget>0?Math.round((loggedH/totalBudget)*100):0;
    const status=pct>=100?'over':pct>=80?'near':'ok';

    const card=document.createElement('div'); card.className=`project-card ${status}`;
    card.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
        <div>
          <div style="font-weight:800;font-size:16px;">${proj.name}</div>
          <div style="font-size:12px;color:#718096;">üè¢ ${proj.client} ¬∑ ${fmtD(proj.startDate)} ‚Üí ${fmtD(proj.endDate)}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:18px;font-weight:800;color:${status==='over'?'#e53e3e':status==='near'?'#d69e2e':'#38a169'};">${pct}% used</div>
          <div style="font-size:12px;color:#718096;">${hrsToHM(loggedH)} of ${totalBudget}h budget</div>
        </div>
      </div>
      <div style="background:#e2e8f0;border-radius:4px;height:8px;margin-bottom:16px;">
        <div style="height:8px;border-radius:4px;background:${status==='over'?'#e53e3e':status==='near'?'#d69e2e':'#38a169'};width:${Math.min(100,pct)}%;transition:width 0.4s;"></div>
      </div>
      <div id="phases-${proj.id}"></div>
      <div style="display:flex;gap:8px;margin-top:12px;">
        <button class="btn btn-ghost btn-sm" data-log="${proj.id}">‚è±Ô∏è Log Time</button>
        ${currentUser.isAdmin?`<button class="btn btn-ghost btn-sm" data-edit="${proj.id}">‚úèÔ∏è Edit</button>`:''}
      </div>
    `;
    // Phase rows
    const phasesDiv=card.querySelector(`#phases-${proj.id}`);
    PHASES.forEach(ph=>{
      const budget=proj.phases[ph]||0; if(!budget) return;
      const loggedMins=phaseLoggedMins(proj.id,ph);
      const loggedHrs=loggedMins/60;
      const pp=budget>0?Math.min(100,Math.round((loggedHrs/budget)*100)):0;
      const st=pp>=100?'over':pp>=80?'near':'ok';
      const row=document.createElement('div'); row.className='phase-row';
      row.innerHTML=`<span class="phase-name">${ph}</span><div class="phase-bar-wrap"><div class="phase-bar-fill ${st}" style="width:${pp}%;"></div></div><span class="phase-nums">${minsToHM(loggedMins)} / <strong>${budget}h</strong> <span style="color:${st==='over'?'#e53e3e':st==='near'?'#d69e2e':'#38a169'}">(${pp}%)</span></span>`;
      phasesDiv.appendChild(row);
    });

    card.querySelector('[data-log]')?.addEventListener('click',()=>openLogModal(proj.id));
    card.querySelector('[data-edit]')?.addEventListener('click',()=>openProjectModal(proj.id));
    el.appendChild(card);
  });
}

function openProjectModal(projId){
  const proj=projId?projectsData.find(p=>p.id===projId):null;
  document.getElementById('projModalTitle').textContent=projId?'Edit Project':'New Project';
  document.getElementById('pName').value=proj?.name||'';
  
  // Populate client dropdown
  const clientSel = document.getElementById('pClientSelect');
  clientSel.innerHTML = '<option value="">Select client...</option>' + 
    clients.map(c => `<option value="${c}">${c}</option>`).join('') +
    '<option value="__NEW__">+ Add New Client</option>';
  
  if(proj?.client) {
    clientSel.value = proj.client;
  }
  document.getElementById('pNewClientDiv').style.display = 'none';
  document.getElementById('pNewClient').value = '';
  
  document.getElementById('pStart').value=proj?.startDate||fmt(new Date());
  document.getElementById('pEnd').value=proj?.endDate||'';
  // Build phase budget inputs
  const pf=document.getElementById('phaseBudgetFields'); pf.innerHTML='';
  PHASES.forEach(ph=>{
    const row=document.createElement('div'); row.className='form-row'; row.style.marginBottom='10px';
    row.innerHTML=`<div style="display:flex;align-items:center;font-size:13px;font-weight:500;">${ph}</div><div><input type="number" class="form-control" id="phase_${ph.replace(/\s+/g,'_')}" placeholder="Budget hours" min="0" step="1" value="${proj?.phases[ph]||0}"></div>`;
    pf.appendChild(row);
  });
  document.getElementById('saveProjBtn')._editId=projId;
  openModal('projectModal');
}

// Show/hide new client field
document.getElementById('pClientSelect').addEventListener('change', function(){
  const isNew = this.value === '__NEW__';
  document.getElementById('pNewClientDiv').style.display = isNew ? 'block' : 'none';
  if(isNew) document.getElementById('pNewClient').focus();
});

document.getElementById('saveProjBtn').addEventListener('click',function(){
  const name=document.getElementById('pName').value.trim();
  let client = document.getElementById('pClientSelect').value;
  
  // Handle new client
  if(client === '__NEW__') {
    client = document.getElementById('pNewClient').value.trim();
    if(!client) { alert('Enter the new client name'); return; }
    // Add to clients list if not already there
    if(!clients.includes(client)) {
      clients.push(client);
      clients.sort(); // Keep alphabetically sorted
    }
  }
  
  if(!name||!client){ alert('Project name and client are required'); return; }
  const phases={};
  PHASES.forEach(ph=>{ const v=parseInt(document.getElementById('phase_'+ph.replace(/\s+/g,'_')).value)||0; if(v>0) phases[ph]=v; });
  const data={ id:this._editId||genId(), name, client, startDate:document.getElementById('pStart').value, endDate:document.getElementById('pEnd').value, phases };
  if(this._editId){ const i=projectsData.findIndex(p=>p.id===this._editId); projectsData[i]=data; }
  else projectsData.push(data);
  autoSave();
  closeModal('projectModal'); renderProjectsBudget();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TIME REPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MONTHS_ARR=['January','February','March','April','May','June','July','August','September','October','November','December'];
function initTimeReport(){
  const sel=document.getElementById('trYear'); if(sel.options.length>0) return;
  const cy=new Date().getFullYear();
  for(let y=cy-2;y<=cy+1;y++){ const o=document.createElement('option'); o.value=y; o.textContent=y; if(y===cy) o.selected=true; sel.appendChild(o); }
  document.getElementById('trFrom').value=new Date().getMonth();
  document.getElementById('trTo').value=new Date().getMonth();
  document.getElementById('trRunBtn').addEventListener('click', runTimeReport);
  document.getElementById('trPdfBtn2').addEventListener('click', exportPDF);
}

function runTimeReport(){
  // Get current selections before regenerating
  const currentUserId = document.getElementById('trUser').value;
  const currentProjId = document.getElementById('trProject').value;
  
  // Regenerate dropdowns
  document.getElementById('trUser').innerHTML='<option value="">All Members</option>'+users.map(u=>`<option value="${u.id}">${u.name}</option>`).join('');
  document.getElementById('trProject').innerHTML='<option value="">All Projects</option>'+projectsData.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  
  // Restore selections
  if(currentUserId) document.getElementById('trUser').value = currentUserId;
  if(currentProjId) document.getElementById('trProject').value = currentProjId;
  
  const fromM=parseInt(document.getElementById('trFrom').value);
  const toM=parseInt(document.getElementById('trTo').value);
  const year=parseInt(document.getElementById('trYear').value);
  const userId=document.getElementById('trUser').value;
  const projId=document.getElementById('trProject').value;
  const view=document.getElementById('trView').value;

  let logs=timeLogs.filter(l=>currentUser.isAdmin||l.userId===currentUser.id);
  logs=logs.filter(l=>{ const d=new Date(l.date); return d.getFullYear()===year&&d.getMonth()>=fromM&&d.getMonth()<=toM; });
  if(userId) logs=logs.filter(l=>l.userId===userId);
  // Filter by project: if specific project selected, show only that project
  // If "All Projects", show everything including non-productive
  if(projId) logs=logs.filter(l=>l.projectId===projId);

  document.getElementById('trOutput').style.display='block';
  const total=logs.reduce((s,l)=>s+l.durationMins,0);
  const prodMins=logs.filter(l=>l.productive).reduce((s,l)=>s+l.durationMins,0);
  document.getElementById('trStats').innerHTML=`
    <div class="stat-card"><div class="stat-num">${minsToHM(total)}</div><div class="stat-lbl">Total Time</div></div>
    <div class="stat-card g"><div class="stat-num">${minsToHM(prodMins)}</div><div class="stat-lbl">Productive</div></div>
    <div class="stat-card r"><div class="stat-num">${minsToHM(total-prodMins)}</div><div class="stat-lbl">Non-Productive</div></div>
    <div class="stat-card o"><div class="stat-num">${logs.length}</div><div class="stat-lbl">Log Entries</div></div>`;
  const fromL=MONTHS_ARR[fromM],toL=fromM===toM?'':' ‚Äì '+MONTHS_ARR[toM];
  const uL=userId?users.find(u=>u.id===userId)?.name:'All Members';
  const pL=projId?projectsData.find(p=>p.id===projId)?.name:'All Projects';
  document.getElementById('trTitle').textContent=fromL+toL+' '+year;
  document.getElementById('trSubtitle').textContent=uL+' ¬∑ '+pL;
  document.getElementById('trPersonSec').style.display=view!=='project'?'block':'none';
  document.getElementById('trProjSec').style.display=view!=='person'?'block':'none';
  if(view!=='project') buildTrPerson(logs,total);
  if(view!=='person')  buildTrProject(logs,total);
  buildTrDetail(logs);
}

function buildTrPerson(logs,total){
  const byU={};
  logs.forEach(l=>{ if(!byU[l.userId]) byU[l.userId]={mins:0,n:0,projects:{}}; byU[l.userId].mins+=l.durationMins; byU[l.userId].n++; if(!byU[l.userId].projects[l.projectName||l.activity||'-']) byU[l.userId].projects[l.projectName||l.activity||'-']=0; byU[l.userId].projects[l.projectName||l.activity||'-']+=l.durationMins; });
  const sorted=Object.entries(byU).sort((a,b)=>b[1].mins-a[1].mins); const maxM=sorted[0]?.[1].mins||1;
  let html=`<table class="rpt-table"><thead><tr><th>Member</th><th>Breakdown</th><th style="text-align:right">Time</th><th style="text-align:right">Share</th></tr></thead><tbody>`;
  sorted.forEach(([uid,d])=>{ const u=users.find(u=>u.id===uid); const pct=((d.mins/total)*100).toFixed(1); const bar=((d.mins/maxM)*100).toFixed(1);
    const rows=Object.entries(d.projects).sort((a,b)=>b[1]-a[1]).map(([p,m])=>`<tr class="sub"><td colspan="2">üìÅ ${p}</td><td style="text-align:right;color:#2b6cb0;font-weight:600;">${minsToHM(m)}</td><td style="text-align:right;color:#718096;">${((m/total)*100).toFixed(1)}%</td></tr>`).join('');
    html+=`<tr><td><b>${u?.name||'?'}</b><br><span style="font-size:10px;color:#a0aec0;">${d.n} entries</span></td><td><div class="bar-wrap"><div class="bar-fill" style="width:${bar}%"></div></div></td><td style="text-align:right;font-weight:800;font-size:14px;">${minsToHM(d.mins)}</td><td style="text-align:right;font-weight:700;color:#6b46c1;">${pct}%</td></tr>${rows}<tr><td colspan="4" style="border:none;height:6px;"></td></tr>`;
  });
  document.getElementById('trPersonTbl').innerHTML=html+'</tbody></table>';
}

function buildTrProject(logs,total){
  const byP={};
  logs.forEach(l=>{ const key=l.projectName||l.activity||'Non-Productive'; if(!byP[key]) byP[key]={mins:0,n:0,phases:{},people:{}}; byP[key].mins+=l.durationMins; byP[key].n++;
    if(l.phase){ if(!byP[key].phases[l.phase]) byP[key].phases[l.phase]=0; byP[key].phases[l.phase]+=l.durationMins; }
    const un=users.find(u=>u.id===l.userId)?.name||'?'; if(!byP[key].people[un]) byP[key].people[un]=0; byP[key].people[un]+=l.durationMins;
  });
  const sorted=Object.entries(byP).sort((a,b)=>b[1].mins-a[1].mins); const maxM=sorted[0]?.[1].mins||1;
  const cols=['#2b6cb0','#38a169','#d69e2e','#6b46c1','#e53e3e','#0987a0'];
  let html=`<table class="rpt-table"><thead><tr><th>Project</th><th>Team & Phases</th><th style="text-align:right">Time</th><th style="text-align:right">Share</th></tr></thead><tbody>`;
  sorted.forEach(([pname,d],idx)=>{ const color=cols[idx%cols.length]; const pct=((d.mins/total)*100).toFixed(1); const bar=((d.mins/maxM)*100).toFixed(1);
    const phRows=Object.entries(d.phases).sort((a,b)=>b[1]-a[1]).map(([ph,m])=>`<tr class="sub"><td colspan="2">üìê ${ph}</td><td style="text-align:right;color:${color};font-weight:600;">${minsToHM(m)}</td><td style="text-align:right;color:#718096;">${((m/total)*100).toFixed(1)}%</td></tr>`).join('');
    const peRows=Object.entries(d.people).sort((a,b)=>b[1]-a[1]).map(([pn,m])=>`<tr class="sub"><td colspan="2">üë§ ${pn}</td><td style="text-align:right;color:${color};font-weight:600;">${minsToHM(m)}</td><td></td></tr>`).join('');
    html+=`<tr><td><b style="color:${color};">üìÅ ${pname}</b><br><span style="font-size:10px;color:#a0aec0;">${d.n} entries</span></td><td><div class="bar-wrap"><div class="bar-fill" style="width:${bar}%;background:${color};"></div></div></td><td style="text-align:right;font-weight:800;font-size:14px;">${minsToHM(d.mins)}</td><td style="text-align:right;font-weight:700;color:#6b46c1;">${pct}%</td></tr>${phRows}${peRows}<tr><td colspan="4" style="border:none;height:6px;"></td></tr>`;
  });
  document.getElementById('trProjTbl').innerHTML=html+'</tbody></table>';
}

function buildTrDetail(logs){
  const sorted=logs.slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
  let html=`<table class="rpt-table"><thead><tr><th>Date</th><th>Member</th><th>Project / Activity</th><th>Phase</th><th>Typology</th><th>Description</th><th style="text-align:right">Time</th></tr></thead><tbody>`;
  sorted.forEach(l=>{ const u=users.find(u=>u.id===l.userId);
    html+=`<tr><td style="white-space:nowrap">${fmtD(l.date)}</td><td><b>${u?.name||'?'}</b></td><td style="color:#2b6cb0;font-weight:600;">${l.productive?'üìÅ '+l.projectName:'üî∏ '+l.activity}</td><td style="font-size:11px;">${l.phase||'-'}</td><td style="font-size:11px;">${l.typology||'-'}</td><td>${l.desc}</td><td style="text-align:right;font-weight:700;color:#2b6cb0;white-space:nowrap;">${minsToHM(l.durationMins)}</td></tr>`;
  });
  const tot=logs.reduce((s,l)=>s+l.durationMins,0);
  html+=`<tr style="background:#f7fafc;font-weight:700;"><td colspan="6" style="text-align:right;">Grand Total:</td><td style="text-align:right;color:#2b6cb0;font-size:15px;">${minsToHM(tot)}</td></tr>`;
  document.getElementById('trDetailTbl').innerHTML=html+'</tbody></table>';
}

function exportPDF(){
  const title=document.getElementById('trTitle').textContent;
  const subtitle=document.getElementById('trSubtitle').textContent;
  const pw=window.open('','_blank');
  pw.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>SQUARE Report</title><style>
    *{margin:0;padding:0;box-sizing:border-box;}body{font-family:-apple-system,sans-serif;color:#1a202c;padding:28px;font-size:12px;}
    .hdr{border-bottom:3px solid #2b6cb0;padding-bottom:12px;margin-bottom:18px;display:flex;justify-content:space-between;align-items:flex-end;}
    .logo{font-size:24px;font-weight:800;color:#2b6cb0;letter-spacing:4px;}.rt{font-size:17px;font-weight:700;margin-top:3px;}.rs{font-size:11px;color:#718096;margin-top:2px;}.gen{font-size:10px;color:#a0aec0;text-align:right;}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:18px;}
    .sc{background:#f7fafc;border-radius:6px;padding:10px;text-align:center;border-top:3px solid #2b6cb0;}
    .sc:nth-child(2){border-top-color:#38a169;}.sc:nth-child(3){border-top-color:#e53e3e;}.sc:nth-child(4){border-top-color:#d69e2e;}
    .sn{font-size:18px;font-weight:800;}.sl{font-size:10px;color:#718096;margin-top:1px;}
    .sec{margin-bottom:22px;}.st{font-size:13px;font-weight:700;margin-bottom:8px;padding-bottom:5px;border-bottom:2px solid #e2e8f0;}
    table{width:100%;border-collapse:collapse;font-size:11px;}th{background:#f7fafc;padding:6px 10px;text-align:left;font-weight:700;border-bottom:2px solid #e2e8f0;}
    td{padding:6px 10px;border-bottom:1px solid #f0f4f8;}.sub td{padding:2px 10px 2px 20px;border:none;font-size:10px;}tr:last-child td{border-bottom:none;}
    .bar-wrap{background:#e2e8f0;border-radius:3px;height:5px;}.bar-fill{height:5px;border-radius:3px;background:#2b6cb0;}
    .ftr{margin-top:22px;padding-top:10px;border-top:1px solid #e2e8f0;font-size:10px;color:#a0aec0;text-align:center;}
    @page{margin:1.5cm;}
  </style></head><body>
  <div class="hdr"><div><div class="logo">SQUARE</div><div class="rt">Time Report ‚Äì ${title}</div><div class="rs">${subtitle}</div></div>
  <div class="gen">Generated ${new Date().toLocaleDateString('en-IN',{day:'numeric',month:'long',year:'numeric'})}</div></div>
  <div class="stats">`);
  const sn=document.querySelectorAll('#trStats .stat-num'),sl=document.querySelectorAll('#trStats .stat-lbl');
  for(let i=0;i<4;i++) pw.document.write(`<div class="sc"><div class="sn">${sn[i]?.textContent||'-'}</div><div class="sl">${sl[i]?.textContent||''}</div></div>`);
  pw.document.write('</div>');
  if(document.getElementById('trPersonSec').style.display!=='none') pw.document.write(`<div class="sec"><div class="st">By Team Member</div>${document.getElementById('trPersonTbl').innerHTML}</div>`);
  if(document.getElementById('trProjSec').style.display!=='none') pw.document.write(`<div class="sec"><div class="st">By Project & Phase</div>${document.getElementById('trProjTbl').innerHTML}</div>`);
  pw.document.write(`<div class="sec"><div class="st">Detailed Log</div>${document.getElementById('trDetailTbl').innerHTML}</div>`);
  pw.document.write(`<div class="ftr">SQUARE Office Management &bull; Confidential &bull; ${new Date().getFullYear()}</div></body></html>`);
  pw.document.close(); setTimeout(()=>{ pw.focus(); pw.print(); },600);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEAVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('applyLeaveBtn').addEventListener('click',()=>{
  document.getElementById('lType').value=''; document.getElementById('lStart').value=fmt(new Date());
  document.getElementById('lEnd').value=fmt(new Date()); document.getElementById('lReason').value='';
  document.getElementById('lDayInfo').textContent='Working days: ‚Äî'; openModal('leaveModal');
});
['lStart','lEnd'].forEach(id=>document.getElementById(id).addEventListener('change',()=>{
  const s=document.getElementById('lStart').value,e=document.getElementById('lEnd').value;
  if(s&&e&&e>=s){ const d=workDays(s,e); document.getElementById('lDayInfo').textContent=`üìÖ ${d} working day${d!==1?'s':''} (Sundays & 2nd/4th Saturdays excluded)`; }
}));
document.getElementById('submitLeaveBtn').addEventListener('click',()=>{
  const type=document.getElementById('lType').value,start=document.getElementById('lStart').value,end=document.getElementById('lEnd').value,reason=document.getElementById('lReason').value.trim();
  if(!type||!start||!end||!reason){ alert('Fill all fields'); return; }
  const days=workDays(start,end); const user=users.find(u=>u.id===currentUser.id);
  if(type==='medical'&&days>user.medLeft){ alert(`Only ${user.medLeft} medical days left`); return; }
  if(type==='casual'&&days>user.casLeft){ alert(`Only ${user.casLeft} casual days left`); return; }
  leaveRequests.push({ id:genId(), userId:currentUser.id, userName:currentUser.name, type, startDate:start, endDate:end, days, reason, status:'pending', date:fmt(new Date()) });
  autoSave();
  closeModal('leaveModal'); updateApprovalBadge(); renderLeaves(); alert('Leave submitted!');
});
function renderLeaves(){
  const user=users.find(u=>u.id===currentUser.id);
  const mU=12-user.medLeft,cU=5-user.casLeft;
  document.getElementById('leaveBalance').innerHTML=`
    <div class="balance-card"><div style="font-size:12px;color:#718096;margin-bottom:6px;">üè• Medical Leave</div><div class="balance-num" style="color:#3182ce;">${user.medLeft}</div><div class="balance-sub">${mU} used of 12</div><div class="bal-bar"><div class="bal-fill" style="width:${(mU/12)*100}%;background:#3182ce;"></div></div></div>
    <div class="balance-card"><div style="font-size:12px;color:#718096;margin-bottom:6px;">üå¥ Casual Leave</div><div class="balance-num" style="color:#38a169;">${user.casLeft}</div><div class="balance-sub">${cU} used of 5</div><div class="bal-bar"><div class="bal-fill" style="width:${(cU/5)*100}%;background:#38a169;"></div></div></div>`;
  const el=document.getElementById('myLeaveList');
  const my=leaveRequests.filter(l=>l.userId===currentUser.id).slice().reverse();
  if(!my.length){ el.innerHTML='<p style="color:#718096;padding:16px;">No applications yet.</p>'; return; }
  el.innerHTML=my.map(lv=>`<div class="approval-card"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;"><div><div style="font-weight:700;">${lv.type==='medical'?'üè• Medical':'üå¥ Casual'} Leave</div><div style="font-size:11px;color:#718096;">${fmtD(lv.startDate)} ‚Üí ${fmtD(lv.endDate)} ¬∑ ${lv.days} day${lv.days!==1?'s':''}</div></div><span class="badge badge-${lv.status}">${lv.status}</span></div><div style="font-size:12px;color:#4a5568;">${lv.reason}</div></div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPROVALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderApprovals(){
  const el=document.getElementById('approvalsList');
  if(!currentUser.isAdmin){ el.innerHTML='<p style="color:#718096;padding:16px;">Only admins can view approvals.</p>'; return; }
  const pl=leaveRequests.filter(l=>l.status==='pending');
  const pc=changeRequests.filter(r=>r.status==='pending');
  if(!pl.length&&!pc.length){ el.innerHTML='<p style="color:#718096;padding:16px;">‚úÖ No pending approvals!</p>'; return; }
  el.innerHTML='';
  pl.forEach(lv=>{ const c=document.createElement('div'); c.className='approval-card';
    c.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;"><div><div style="font-weight:700;">üå¥ Leave ¬∑ ${lv.userName}</div><div style="font-size:11px;color:#718096;">${lv.type} ¬∑ ${fmtD(lv.startDate)} ‚Üí ${fmtD(lv.endDate)} ¬∑ ${lv.days}d</div></div><span class="badge badge-pending">Pending</span></div><div style="font-size:12px;margin-bottom:10px;">${lv.reason}</div><div style="display:flex;gap:8px;"><button class="btn btn-success btn-sm">‚úì Approve</button><button class="btn btn-danger btn-sm">‚úó Reject</button></div>`;
    c.querySelector('.btn-success').onclick=()=>{ lv.status='approved'; const u=users.find(u=>u.id===lv.userId); if(lv.type==='medical') u.medLeft=Math.max(0,u.medLeft-lv.days); else u.casLeft=Math.max(0,u.casLeft-lv.days); renderApprovals(); updateApprovalBadge(); };
    c.querySelector('.btn-danger').onclick=()=>{ lv.status='rejected'; renderApprovals(); updateApprovalBadge(); };
    el.appendChild(c);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MANAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderManage(){
  // Users
  const ul=document.getElementById('usersList'); ul.innerHTML='';
  users.forEach((u,i)=>{ const item=document.createElement('div'); item.className='list-item';
    item.innerHTML=`<div><div style="font-weight:600;">${u.name}${u.isAdmin?` <span class="admin-badge">ADMIN</span>`:''}</div><div style="font-size:11px;color:#718096;">${u.email}</div></div>`;
    const btn=document.createElement('button'); btn.className='btn btn-danger btn-sm'; btn.textContent='Delete';
    btn.onclick=()=>{ if(u.id===currentUser.id){ alert("Can't delete yourself"); return; } users.splice(i,1); renderManage(); };
    item.appendChild(btn); ul.appendChild(item);
  });
  // Clients
  const cl=document.getElementById('clientsList'); cl.innerHTML='';
  clients.forEach((c,i)=>{ const item=document.createElement('div'); item.className='list-item';
    const span=document.createElement('span'); span.textContent=c; span.style.fontSize='13px';
    const btn=document.createElement('button'); btn.className='btn btn-danger btn-sm'; btn.textContent='√ó';
    btn.onclick=()=>{ 
      const inUse = projectsData.some(p => p.client === c);
      if(inUse) { alert('Cannot delete - client is used in projects'); return; }
      clients.splice(i,1); renderManage(); 
    };
    item.appendChild(span); item.appendChild(btn); cl.appendChild(item);
  });
  // Typologies
  const tl=document.getElementById('typologyList'); tl.innerHTML='';
  typologies.forEach((t,i)=>{ const item=document.createElement('div'); item.className='list-item';
    const span=document.createElement('span'); span.textContent=t; span.style.fontSize='13px';
    const btn=document.createElement('button'); btn.className='btn btn-danger btn-sm'; btn.textContent='√ó';
    btn.onclick=()=>{ typologies.splice(i,1); renderManage(); };
    item.appendChild(span); item.appendChild(btn); tl.appendChild(item);
  });
}
document.getElementById('addUserBtn').addEventListener('click',()=>{
  const name=document.getElementById('newUserName').value.trim(),email=document.getElementById('newUserEmail').value.trim().toLowerCase(),pass=document.getElementById('newUserPass').value.trim();
  if(!name||!email||!pass){ alert('Fill all fields'); return; }
  if(users.find(u=>u.email===email)){ alert('Email exists'); return; }
  users.push({id:genId(),name,email,password:pass,isAdmin:false,medLeft:12,casLeft:5});
  document.getElementById('newUserName').value=''; document.getElementById('newUserEmail').value=''; document.getElementById('newUserPass').value='';
  autoSave();
  renderManage();
});
document.getElementById('addClientBtn').addEventListener('click',()=>{
  const v=document.getElementById('newClient').value.trim();
  if(!v||clients.includes(v)){ alert(v?'Client already exists':'Enter client name'); return; }
  clients.push(v); clients.sort();
  document.getElementById('newClient').value='';
  autoSave();
  renderManage();
});
document.getElementById('addTypologyBtn').addEventListener('click',()=>{
  const v=document.getElementById('newTypology').value.trim();
  if(!v||typologies.includes(v)){ alert(v?'Already exists':'Enter a name'); return; }
  typologies.push(v); document.getElementById('newTypology').value='';
  autoSave();
  renderManage();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FLOATING TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('timerNavBtn').addEventListener('click',()=>{
  const w=document.getElementById('timerWidget'); w.style.display=w.style.display==='none'?'flex':'none';
});

// Draggable
(function(){
  const widget=document.getElementById('timerWidget'),handle=document.getElementById('timerHandle');
  let drag=false,sx,sy,or,ob;
  handle.addEventListener('mousedown',e=>{ drag=true; sx=e.clientX; sy=e.clientY; const r=widget.getBoundingClientRect(); or=window.innerWidth-r.right; ob=window.innerHeight-r.bottom; e.preventDefault(); });
  document.addEventListener('mousemove',e=>{ if(!drag) return; widget.style.right=Math.max(0,or+(sx-e.clientX))+'px'; widget.style.bottom=Math.max(0,ob+(sy-e.clientY))+'px'; });
  document.addEventListener('mouseup',()=>{ drag=false; });
  handle.addEventListener('touchstart',e=>{ const t=e.touches[0]; drag=true; sx=t.clientX; sy=t.clientY; const r=widget.getBoundingClientRect(); or=window.innerWidth-r.right; ob=window.innerHeight-r.bottom; },{passive:true});
  document.addEventListener('touchmove',e=>{ if(!drag) return; const t=e.touches[0]; widget.style.right=Math.max(0,or+(sx-t.clientX))+'px'; widget.style.bottom=Math.max(0,ob+(sy-t.clientY))+'px'; },{passive:true});
  document.addEventListener('touchend',()=>{ drag=false; });
})();

try {
  document.getElementById('timerStartBtn').addEventListener('click',()=>{
    console.log('Timer button clicked');
    // Get today's planned work for current user
    const today = fmt(new Date());
    console.log('Today:', today);
    console.log('Current user:', currentUser);
    console.log('Plan entries:', planEntries);
    
    const myPlans = planEntries.filter(p => p.userId === currentUser.id && p.date === today && !p.done);
    console.log('My plans for today:', myPlans);
    
    if(myPlans.length === 0) {
      console.log('No plans found, user is admin:', currentUser.isAdmin);
      if(currentUser.isAdmin) {
        const confirmed = confirm('‚ö†Ô∏è No planned work for today!\n\nPlanning is mandatory for all team members.\n\nAs admin, do you want to start an unplanned timer anyway?');
        console.log('Admin confirmed:', confirmed);
        if(!confirmed) return;
        timerLinkedPlan = null;
      } else {
        alert('‚ö†Ô∏è No planned work for today!\n\nPlanning is mandatory. Please go to Weekly Planner and assign work for today before starting the timer.');
        return;
      }
    } else {
      console.log('Found', myPlans.length, 'plans');
      
      // If only one plan, auto-select it
      if(myPlans.length === 1) {
        timerLinkedPlan = myPlans[0];
        console.log('Auto-selected single plan:', timerLinkedPlan);
      } else {
        // Multiple plans - show picker
        const opts = myPlans.map((p,i) => `${i+1}. [${p.project}] ${p.phase || ''} ${p.typology || ''}`).join('\n');
        console.log('Options:', opts);
        const choice = prompt(`You have ${myPlans.length} planned tasks for today.\n\n${opts}\n\nEnter number (1-${myPlans.length}):`);
        console.log('User choice:', choice);
        
        if(!choice) {
          console.log('User cancelled prompt');
          return;
        }
        const idx = parseInt(choice) - 1;
        console.log('Parsed index:', idx);
        if(idx < 0 || idx >= myPlans.length) { 
          console.log('Invalid index');
          alert('Invalid selection'); 
          return; 
        }
        
        timerLinkedPlan = myPlans[idx];
        console.log('Selected plan:', timerLinkedPlan);
      }
    }
    
    console.log('Starting timer...');
    timerStartedAt=Date.now(); timerPausedMs=0; timerRunning=true;
    document.getElementById('timerWidget').classList.add('running');
    document.getElementById('timerPreStart').style.display='none';
    document.getElementById('timerRunning').style.display='block';
    document.getElementById('timerDisplay').classList.add('running');
    document.getElementById('timerStatus').textContent='‚óè Recording...';
    
    if(timerLinkedPlan) {
      document.getElementById('timerProject').style.display='block';
      document.getElementById('timerProject').textContent=`üìÅ ${timerLinkedPlan.project}`;
    } else {
      document.getElementById('timerProject').style.display='block';
      document.getElementById('timerProject').textContent='‚ö†Ô∏è Unplanned';
      document.getElementById('timerProject').style.background='#fff5f5';
      document.getElementById('timerProject').style.color='#e53e3e';
    }
    
    document.getElementById('timerNavLabel').textContent='‚è± Running...';
    timerInterval=setInterval(()=>{ document.getElementById('timerDisplay').textContent=secsToHMS(getElapsed(timerStartedAt,timerPausedMs)); },1000);
    console.log('Timer started successfully');
  });
  console.log('Timer start button listener attached successfully');
} catch(e) {
  console.error('Error setting up timer start button:', e);
  alert('Timer setup error: ' + e.message);
}

document.getElementById('timerStopBtn').addEventListener('click',()=>{
  try {
    console.log('Stop button clicked');
    clearInterval(timerInterval);
    timerRunning = false;
    
    const parts=document.getElementById('timerDisplay').textContent.split(':').map(Number);
    console.log('Timer parts:', parts);
    const totalSecs=parts[0]*3600+parts[1]*60+parts[2];
    const mins=Math.max(1,Math.round(totalSecs/60));
    console.log('Total seconds:', totalSecs, 'minutes:', mins);
    
    if(totalSecs < 60) {
      alert('Timer must run for at least 1 minute');
      timerStartedAt=Date.now(); timerRunning=true;
      timerInterval=setInterval(()=>{ document.getElementById('timerDisplay').textContent=secsToHMS(getElapsed(timerStartedAt,timerPausedMs)); },1000);
      return;
    }
    
    console.log('Auto-saving log entry...');
    
    // Auto-generate description from plan
    const autoDesc = timerLinkedPlan 
      ? `${timerLinkedPlan.typology || timerLinkedPlan.phase || 'Work on project'}`
      : 'Non-productive work';
    
    const logEntry = {
      id: genId(),
      userId: currentUser.id,
      date: fmt(new Date()),
      projectId: timerLinkedPlan?.projectId || '',
      projectName: timerLinkedPlan?.project || '',
      phase: timerLinkedPlan?.phase || '',
      typology: timerLinkedPlan?.typology || '',
      activity: '',
      durationMins: mins,
      startTime: '',
      endTime: '',
      desc: autoDesc,
      productive: !!timerLinkedPlan,
      ts: Date.now()
    };
    console.log('Log entry created:', logEntry);
    
    timeLogs.push(logEntry);
    console.log('timeLogs now has', timeLogs.length, 'entries');
    
    // Mark plan as done if linked
    if(timerLinkedPlan) {
      const plan = planEntries.find(p => p.id === timerLinkedPlan.id);
      if(plan) plan.done = true;
    }
    
    autoSave();
    resetTimer();
    renderTimeLog();
    renderProjectsBudget();
    renderDashboard();
    
    alert(`‚úÖ Logged: ${minsToHM(mins)}\n\n${timerLinkedPlan ? `üìÅ ${timerLinkedPlan.project}` : 'Non-productive work'}`);
    console.log('Auto-save completed successfully');
  } catch(error) {
    console.error('Error in stop button:', error);
    alert('Error saving time: ' + error.message);
  }
});

function resetTimer(){
  timerRunning=false; timerStartedAt=null; timerPausedMs=0; timerLinkedPlan=null; clearInterval(timerInterval);
  document.getElementById('timerDisplay').textContent='00:00:00'; document.getElementById('timerDisplay').classList.remove('running');
  document.getElementById('timerStatus').textContent='Timer ready';
  const projBadge = document.getElementById('timerProject');
  projBadge.style.display='none';
  projBadge.style.background='#ebf4ff';
  projBadge.style.color='#2b6cb0';
  document.getElementById('timerPreStart').style.display='block'; document.getElementById('timerRunning').style.display='none';
  document.getElementById('timerWidget').classList.remove('running'); document.getElementById('timerNavLabel').textContent='Start Timer';
}

</script>
</body>
</html>
